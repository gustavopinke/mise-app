<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>MISE - Scanner</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #66F7CC;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px 20px 40px 20px;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: white;
      border-radius: 20px;
      padding: 0;
      text-align: center;
      overflow: hidden;
    }

    .logo-container {
      background: #66F7CC;
      padding: 25px 15px;
      margin: 0;
      width: 100%;
      transition: all 0.3s ease;
    }


    .logo {
      width: 150px;
      display: block;
      margin: 0 auto;
      transition: all 0.3s ease;
    }

    .form-content {
      padding: 25px;
    }

    h2 {
      margin-top: 5px;
      font-weight: bold;
      color: #222;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      margin-top: 10px;
    }

    input {
      width: 100%;
      padding: 12px 45px 12px 12px;
      border: 2px solid #ccc;
      border-radius: 10px;
      font-size: 18px;
      text-align: center;
      box-sizing: border-box;
      -moz-appearance: textfield;
    }

    .clear-button {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: #ccc;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      line-height: 28px;
      padding: 0;
      margin: 0;
      transition: all 0.2s;
      font-family: Arial, sans-serif;
      font-weight: normal;
      text-align: center;
      vertical-align: middle;
    }

    .clear-button:hover {
      background: #999;
    }

    .clear-button.visible {
      display: flex;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      margin-top: 15px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
    }

    #buscar {
      background: #66F7CC;
      color: #222;
    }

    #scanner {
      background: #6a5acd;
      color: white;
    }

    button svg {
      width: 20px;
      height: 20px;
    }

    .produto-card {
      background: #f2f2f2;
      margin-top: 20px;
      padding: 18px;
      border-radius: 12px;
      text-align: left;
    }

    .produto-card h3 {
      margin: 0;
      font-size: 20px;
    }

    .produto-info {
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.8;
    }

    .produto-info p {
      margin: 8px 0;
    }

    #video-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #video-container.active {
      display: flex;
    }

    .camera-wrapper {
      position: relative;
      width: 95%;
      max-width: 700px;
      aspect-ratio: 4/3;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(102, 247, 204, 0.3);
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #close-camera {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      color: #66F7CC;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
    }

    .scanner-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 350px;
      aspect-ratio: 3/2;
      border: 3px solid #66F7CC;
      border-radius: 10px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }

    .scanner-line {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 76%;
      max-width: 330px;
      height: 3px;
      background: linear-gradient(90deg, transparent, #66F7CC, transparent);
      box-shadow: 0 0 15px #66F7CC, 0 0 30px #66F7CC;
      animation: scan 2s ease-in-out infinite;
      pointer-events: none;
    }

    .produto-imagem {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 12px;
      margin: 15px auto;
      display: block;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .produto-imagem:hover {
      transform: scale(1.02);
    }

    #image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #image-modal.active {
      display: flex;
    }

    #modal-image {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(102, 247, 204, 0.5);
    }

    #close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      color: #333;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      z-index: 2001;
    }

    @keyframes scan {
      0%, 100% {
        transform: translate(-50%, -50%) translateY(-100px);
        opacity: 0.3;
      }
      50% {
        transform: translate(-50%, -50%) translateY(100px);
        opacity: 1;
      }
    }

    .scan-status {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }

  </style>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>

<body>

  <div class="container">

    <div class="logo-container">
      <img src="logo-mise.png" class="logo" />
    </div>

    <div class="form-content">
      <h2>Scanner de C√≥digos de Barras</h2>

      <!-- INPUT COM TYPE TEXT PARA EVITAR SETAS -->
      <div class="input-wrapper">
        <input
            id="codigo"
            type="text"
            placeholder="Digite ou escaneie o c√≥digo"
            inputmode="numeric"
            pattern="[0-9]*"
        />
        <button class="clear-button" id="clear-button">‚úï</button>
      </div>

      <button id="buscar">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        Buscar Produto
      </button>

      <button id="scanner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        Scanner
      </button>

      <div id="resultado"></div>
    </div>
  </div>

  <!-- CONTAINER DA C√ÇMERA -->
  <div id="video-container">
    <button id="close-camera">‚úï Fechar</button>
    <div class="camera-wrapper">
      <video id="video" playsinline></video>
      <div class="scanner-frame"></div>
      <div class="scanner-line"></div>
      <div class="scan-status">Posicione o c√≥digo de barras no centro</div>
    </div>
  </div>

  <!-- MODAL PARA FOTO EM TAMANHO GRANDE -->
  <div id="image-modal">
    <button id="close-modal">‚úï Fechar</button>
    <img id="modal-image" src="" alt="Produto">
  </div>

  <script>
    const input = document.getElementById("codigo");
    const resultado = document.getElementById("resultado");
    const videoContainer = document.getElementById("video-container");
    const video = document.getElementById("video");
    const imageModal = document.getElementById("image-modal");
    const modalImage = document.getElementById("modal-image");
    const scanStatus = document.querySelector(".scan-status");
    const clearButton = document.getElementById("clear-button");
    let codeReader = null;
    let stream = null;
    let ultimaBusca = "";
    let buscaTimeout = null;

    // LIMPAR INPUT AO CLICAR NELE
    input.addEventListener('click', () => {
      input.value = '';
      clearButton.classList.remove('visible');
      resultado.innerHTML = '';
      ultimaBusca = '';
    });

    // MOSTRAR/ESCONDER BOT√ÉO X
    input.addEventListener('input', () => {
      if (input.value.length > 0) {
        clearButton.classList.add('visible');
      } else {
        clearButton.classList.remove('visible');
      }
    });

    // LIMPAR INPUT AO CLICAR NO X
    clearButton.addEventListener('click', (e) => {
      e.preventDefault();
      input.value = '';
      clearButton.classList.remove('visible');
      resultado.innerHTML = '';
      ultimaBusca = '';
      input.focus();
    });

    // MODAL DE IMAGEM
    function abrirImagemModal(src) {
      modalImage.src = src;
      imageModal.classList.add('active');
    }

    function fecharImagemModal() {
      imageModal.classList.remove('active');
      modalImage.src = '';
    }

    document.getElementById("close-modal").onclick = fecharImagemModal;
    imageModal.onclick = (e) => {
      if (e.target === imageModal) {
        fecharImagemModal();
      }
    };

    // ENTER dispara busca
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        buscar();
      }
    });

    // Auto-busca quando digitar c√≥digo completo (debounce)
    input.addEventListener("input", (e) => {
      const codigo = e.target.value.replace(/\D/g, "");

      if (buscaTimeout) clearTimeout(buscaTimeout);

      // Auto-busca se tiver 8+ d√≠gitos (c√≥digo de barras comum)
      if (codigo.length >= 8 && codigo.length <= 14) {
        buscaTimeout = setTimeout(() => {
          // S√≥ buscar se o c√≥digo for diferente do √∫ltimo buscado
          if (codigo !== ultimaBusca) {
            buscar();
          }
        }, 500); // Reduzido de 800ms para 500ms para busca mais r√°pida
      }
    });

    document.getElementById("buscar").onclick = buscar;

    function mostrarProduto(produto, origem) {
      let infoHTML = '';
      // Garantir que o c√≥digo de barras est√° sempre dispon√≠vel
      const codigo = produto['cod de barra'] || produto['cod. de barra'] || produto.codigo || input.value.replace(/\D/g, "");

      // Mostrar todas as informa√ß√µes do produto
      for (const [key, value] of Object.entries(produto)) {
        if (value && key !== 'cod de barra' && key !== 'cod. de barra' && key !== 'codigo' && key !== 'produto' && key !== 'nome' && key !== 'foto') {
          const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
          infoHTML += `<p><b>${label}:</b> ${value}</p>`;
        }
      }

      // Adicionar imagem se existir
      let imagemHTML = '';
      if (produto.foto) {
        console.log('üì∏ Foto do produto:', produto.foto);
        imagemHTML = `<img src="/fotos/${produto.foto}" class="produto-imagem" alt="${produto.produto || produto.nome}" onclick="abrirImagemModal('/fotos/${produto.foto}')" onerror="console.error('Erro ao carregar foto:', this.src); this.style.display='none';">`;
      } else {
        console.log('‚ö†Ô∏è Nenhuma foto dispon√≠vel para o produto');
      }

      resultado.innerHTML = `
        <div class="produto-card">
          ${imagemHTML}
          <h3>${produto.produto || produto.nome || 'Produto Encontrado'}</h3>
          <div class="produto-info">
            <p><b>C√≥digo de Barras:</b> ${codigo}</p>
            ${infoHTML}
          </div>
        </div>
      `;
    }

    async function buscar() {
      const codigo = input.value.replace(/\D/g, "");

      if (!codigo) {
        resultado.innerHTML = "<p style='color: #999; margin-top: 20px;'>Digite um c√≥digo v√°lido.</p>";
        ultimaBusca = "";
        return;
      }

      // Evitar buscas duplicadas do mesmo c√≥digo
      if (codigo === ultimaBusca) {
        console.log("‚ö†Ô∏è C√≥digo j√° buscado, ignorando busca duplicada");
        return;
      }

      // Atualizar ultimaBusca ANTES da busca para evitar duplicatas em requisi√ß√µes r√°pidas
      ultimaBusca = codigo;
      resultado.innerHTML = "<p style='margin-top: 20px;'>üîç Buscando na base local...</p>";

      try {
        console.log("üîç Iniciando busca para c√≥digo:", codigo);
        const resp = await fetch(`/consulta/${codigo}`);
        const data = await resp.json();

        console.log("üì¶ Resposta recebida:", data);

        if (!data.ok) {
          resultado.innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-radius: 10px; color: #c62828;">
              <strong>‚ùå Produto n√£o encontrado</strong>
              <p style="margin: 5px 0 0 0; font-size: 14px;">C√≥digo: ${codigo}</p>
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">${data.mensagem || 'Produto n√£o encontrado em nenhuma base'}</p>
            </div>
          `;
          return;
        }

        console.log("‚úÖ Produto encontrado! Origem:", data.origem);
        mostrarProduto(data.produto, data.origem);
      } catch (error) {
        console.error("‚ùå Erro na busca:", error);
        resultado.innerHTML = `
          <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 10px; color: #e65100;">
            <strong>‚ö†Ô∏è Erro de conex√£o</strong>
            <p style="margin: 5px 0 0 0; font-size: 14px;">Verifique sua internet e tente novamente.</p>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">${error.message}</p>
          </div>
        `;
        // Resetar ultimaBusca em caso de erro para permitir nova tentativa
        ultimaBusca = "";
      }
    }

    // SCANNER DE C√ÇMERA
    document.getElementById("scanner").onclick = async () => {
      try {
        videoContainer.classList.add('active');
        scanStatus.textContent = "Iniciando c√¢mera...";

        codeReader = new ZXing.BrowserBarcodeReader();

        const constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        // Aguardar o v√≠deo carregar antes de iniciar
        await video.play();

        scanStatus.textContent = "Posicione o c√≥digo de barras no centro";

        // Decodificar c√≥digo de barras
        codeReader.decodeFromVideoDevice(null, video, (result, err) => {
          if (result) {
            // Som de sucesso (opcional, pode ser removido se n√£o quiser)
            try {
              const audioContext = new (window.AudioContext || window.webkitAudioContext)();
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();
              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);
              oscillator.frequency.value = 800;
              oscillator.type = 'sine';
              gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
              oscillator.start(audioContext.currentTime);
              oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
              // Ignorar erro de som
            }

            input.value = result.text;
            scanStatus.textContent = "‚úì C√≥digo detectado!";

            setTimeout(() => {
              fecharCamera();
              buscar();
            }, 500);
          }
        });

      } catch (err) {
        console.error('Erro ao acessar c√¢mera:', err);

        let mensagem = 'N√£o foi poss√≠vel acessar a c√¢mera.';
        if (err.name === 'NotAllowedError') {
          mensagem = 'Permiss√£o de c√¢mera negada. Por favor, permita o acesso nas configura√ß√µes do navegador.';
        } else if (err.name === 'NotFoundError') {
          mensagem = 'Nenhuma c√¢mera encontrada no dispositivo.';
        }

        alert(mensagem);
        fecharCamera();
      }
    };

    document.getElementById("close-camera").onclick = fecharCamera;

    // Fechar c√¢mera ao pressionar ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && videoContainer.classList.contains('active')) {
        fecharCamera();
      }
    });

    function fecharCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      if (codeReader) {
        codeReader.reset();
        codeReader = null;
      }
      video.srcObject = null;
      videoContainer.classList.remove('active');
      scanStatus.textContent = "Posicione o c√≥digo de barras no centro";
    }


  </script>
</body>
</html>