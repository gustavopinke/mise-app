<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>MISE - Scanner</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #66F7CC;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 8px 15px 30px 15px;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: transparent;
      border-radius: 20px;
      padding: 0;
      text-align: center;
      overflow: hidden;
    }

    .form-content {
      padding: 15px 20px;
    }

    h2 {
      margin-top: 5px;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 16px;
      color: #333;
      line-height: 1.2;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      margin-top: 10px;
    }

    input {
      width: 100%;
      padding: 12px 45px 12px 12px;
      border: 2px solid #000;
      border-radius: 10px;
      font-size: 18px;
      text-align: center;
      box-sizing: border-box;
      -moz-appearance: textfield;
      background: transparent;
    }

    input::placeholder {
      color: #333;
    }

    /* Toggle Switch */
    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 15px;
      padding: 12px 15px;
      border: 2px solid #000;
      border-radius: 10px;
      background: transparent;
    }

    .toggle-label {
      font-size: 14px;
      font-weight: 600;
      color: #222;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: #6a5acd;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Campos de Peso e Quantidade */
    .peso-container {
      display: none;
      margin-top: 10px;
    }

    .peso-container.visible {
      display: block;
    }

    .peso-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .peso-input {
      flex: 1;
    }

    .bluetooth-btn {
      width: 50px;
      height: 50px;
      min-width: 50px;
      padding: 0;
      margin: 0;
      border-radius: 10px;
      background: #6a5acd;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .bluetooth-btn:hover {
      background: #5a4abd;
    }

    .bluetooth-btn.connected {
      background: #4CAF50;
    }

    .bluetooth-btn svg {
      width: 24px;
      height: 24px;
    }

    .quantidade-container {
      margin-top: 10px;
    }

    /* Label para campos */
    .field-label {
      display: block;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      margin-left: 5px;
    }

    /* Bot√£o Salvar Invent√°rio */
    #salvar-inventario {
      background: #000000;
      color: white;
      margin-top: 10px;
    }

    #salvar-inventario:disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
    }

    #salvar-inventario:not(:disabled):hover {
      background: #333;
    }

    /* Header com Logo */
    .header-logo {
      text-align: center;
      margin-bottom: 10px;
      margin-top: -15px;
    }

    .header-logo img {
      max-width: 130px;
      height: auto;
      margin-bottom: 2px;
    }

    .header-slogan {
      font-size: 22px;
      color: #222;
      font-weight: 500;
      margin-top: -5px;
      margin-bottom: 0;
      letter-spacing: 0.5px;
      line-height: 1.3;
    }

    .scanner-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin: 0 0 12px 0;
      text-align: center;
    }

    .clear-button {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      color: #999;
      border: none;
      width: 20px;
      height: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      line-height: 20px;
      padding: 0;
      margin: 0;
      transition: all 0.2s;
      font-family: Arial, sans-serif;
      font-weight: bold;
      text-align: center;
      vertical-align: middle;
    }

    .clear-button:hover {
      color: #666;
      transform: translateY(-50%) scale(1.1);
    }

    .clear-button.visible {
      display: flex;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      margin-top: 10px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
    }

    #buscar {
      background: #66F7CC;
      color: #222;
    }

    #scanner {
      background: #6a5acd;
      color: white;
    }

    button svg {
      width: 20px;
      height: 20px;
    }

    .produto-card {
      background: #f2f2f2;
      margin-top: 20px;
      padding: 18px;
      border-radius: 12px;
      text-align: left;
    }

    .produto-card h3 {
      margin: 0;
      font-size: 20px;
    }

    .produto-info {
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.8;
    }

    .produto-info p {
      margin: 8px 0;
    }

    /* Badge de fonte */
    .fonte-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .fonte-badge.local {
      background: #e3f2fd;
      color: #1565c0;
    }

    .fonte-badge.online {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .fonte-badge.cache {
      background: #fff3e0;
      color: #ef6c00;
    }

    #scanner-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.98);
      z-index: 1000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #scanner-container.active {
      display: flex;
    }

    #scanner-reader {
      width: 100%;
      max-width: 600px;
      border-radius: 12px;
      overflow: hidden;
    }

    #scanner-reader video {
      border-radius: 12px;
    }

    .scan-status {
      background: rgba(0, 0, 0, 0.8);
      color: #66F7CC;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      margin-top: 20px;
      text-align: center;
    }

    #close-scanner {
      background: #f44336;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      transition: background 0.2s;
      width: auto;
      box-shadow: none;
    }

    #close-scanner:hover {
      background: #d32f2f;
      transform: none;
      box-shadow: none;
    }

    /* Rota√ß√£o do scanner com orienta√ß√£o do dispositivo */
    @media (orientation: landscape) {
      #scanner-reader {
        max-width: 80%;
        max-height: 70vh;
      }
    }

    /* Customizar estilo do html5-qrcode */
    #scanner-reader__scan_region {
      background: transparent !important;
    }

    #scanner-reader__dashboard_section_csr button {
      background: #66F7CC !important;
      color: #000 !important;
      border: none !important;
      padding: 10px 20px !important;
      border-radius: 8px !important;
      font-weight: 600 !important;
    }

    #scanner-reader__dashboard_section_swaplink {
      color: #66F7CC !important;
      text-decoration: none !important;
    }

    /* Esconder textos padr√£o da biblioteca */
    #scanner-reader__header_message,
    #scanner-reader__status_span {
      display: none !important;
    }

    #scanner-reader__scan_region > br,
    #scanner-reader__scan_region > img {
      display: none !important;
    }

    /* Estilo da √°rea de leitura */
    #qr-shaded-region {
      border-color: #66F7CC !important;
    }

    .produto-imagem {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 12px;
      margin: 15px auto;
      display: block;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .produto-imagem:hover {
      transform: scale(1.02);
    }

    #image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      gap: 20px;
    }

    #image-modal.active {
      display: flex;
    }

    #modal-image {
      max-width: 90%;
      max-height: 80%;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(102, 247, 204, 0.5);
    }

    #close-modal {
      background: #66F7CC;
      color: #000;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }

    /* Autocomplete de busca por nome */
    .busca-nome-container {
      position: relative;
      margin-top: 15px;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #000;
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .autocomplete-dropdown.visible {
      display: block;
    }

    .autocomplete-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover {
      background: #f0f0f0;
    }

    .autocomplete-item-nome {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .autocomplete-item-codigo {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

  </style>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body>

  <div class="container">

    <div class="form-content">
      <!-- Logo e Slogan -->
      <div class="header-logo">
        <img src="/logo-mise.png" alt="MISE" onerror="this.style.display='none'">
        <p class="header-slogan">Prepare-se para o sucesso</p>
      </div>

      <p class="scanner-title">Scanner de C√≥digos de Barras</p>

      <!-- INPUT C√ìDIGO DE BARRAS -->
      <div class="input-wrapper">
        <input
            id="codigo"
            type="text"
            placeholder="Digite ou escaneie o c√≥digo"
            inputmode="numeric"
            pattern="[0-9]*"
        />
        <button class="clear-button" id="clear-button">‚úï</button>
      </div>

      <!-- BUSCA POR NOME -->
      <div class="busca-nome-container">
        <label class="field-label">Buscar por nome do produto</label>
        <div class="input-wrapper">
          <input
              id="busca-nome"
              type="text"
              placeholder="Digite o nome do produto..."
          />
          <button class="clear-button" id="clear-busca-nome">‚úï</button>
        </div>
        <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
      </div>

      <!-- TOGGLE PESAGEM -->
      <div class="toggle-container">
        <span class="toggle-label">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
          Pesar produto aberto
        </span>
        <label class="toggle-switch">
          <input type="checkbox" id="toggle-pesagem">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <!-- CAMPO DE PESO (vis√≠vel quando toggle ativo) -->
      <div class="peso-container" id="peso-container">
        <label class="field-label">Peso (kg)</label>
        <div class="peso-wrapper">
          <div class="input-wrapper peso-input">
            <input
                id="peso"
                type="text"
                placeholder="0.000"
                inputmode="decimal"
            />
          </div>
          <button class="bluetooth-btn" id="conectar-balanca" title="Conectar Balan√ßa Bluetooth">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
            </svg>
          </button>
        </div>
        <p id="bluetooth-status" style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Digite o peso ou clique no √≠cone para conectar a balan√ßa</p>
      </div>

      <!-- CAMPO DE QUANTIDADE -->
      <div class="quantidade-container">
        <label class="field-label">Quantidade</label>
        <div class="input-wrapper">
          <input
              id="quantidade"
              type="number"
              placeholder="1"
              min="1"
              value="1"
          />
        </div>
      </div>

      <button id="buscar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        Buscar na base mise
      </button>

      <button id="scanner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        Scanner
      </button>

      <!-- BOT√ÉO SALVAR INVENT√ÅRIO -->
      <button id="salvar-inventario" disabled>
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
          <polyline points="17,21 17,13 7,13 7,21"/>
          <polyline points="7,3 7,8 15,8"/>
        </svg>
        Salvar no Invent√°rio
      </button>

      <div id="resultado"></div>
    </div>
  </div>

  <!-- CONTAINER DO SCANNER -->
  <div id="scanner-container">
    <div id="scanner-reader"></div>
    <div class="scan-status" id="scan-status">Posicione o c√≥digo de barras na √°rea de leitura</div>
    <button id="close-scanner">Fechar C√¢mera</button>
  </div>

  <!-- MODAL PARA FOTO EM TAMANHO GRANDE -->
  <div id="image-modal">
    <img id="modal-image" src="" alt="Produto">
    <button id="close-modal">‚úï Fechar</button>
  </div>

  <script>
    const input = document.getElementById("codigo");
    const resultado = document.getElementById("resultado");
    const scannerContainer = document.getElementById("scanner-container");
    const scannerReader = document.getElementById("scanner-reader");
    const imageModal = document.getElementById("image-modal");
    const modalImage = document.getElementById("modal-image");
    const scanStatus = document.getElementById("scan-status");
    const clearButton = document.getElementById("clear-button");
    let html5QrCode = null;
    let isScanning = false;
    let ultimaBusca = "";
    let buscaTimeout = null;

    // LIMPAR INPUT AO CLICAR NELE
    input.addEventListener('click', () => {
      input.value = '';
      clearButton.classList.remove('visible');
      resultado.innerHTML = '';
      ultimaBusca = '';
    });

    // MOSTRAR/ESCONDER BOT√ÉO X
    input.addEventListener('input', () => {
      if (input.value.length > 0) {
        clearButton.classList.add('visible');
      } else {
        clearButton.classList.remove('visible');
      }
    });

    // LIMPAR INPUT AO CLICAR NO X
    clearButton.addEventListener('click', (e) => {
      e.preventDefault();
      input.value = '';
      clearButton.classList.remove('visible');
      resultado.innerHTML = '';
      ultimaBusca = '';
      input.focus();
    });

    // MODAL DE IMAGEM
    function abrirImagemModal(src) {
      modalImage.src = src;
      imageModal.classList.add('active');
    }

    function fecharImagemModal() {
      imageModal.classList.remove('active');
      modalImage.src = '';
    }

    document.getElementById("close-modal").onclick = fecharImagemModal;
    imageModal.onclick = (e) => {
      if (e.target === imageModal) {
        fecharImagemModal();
      }
    };

    // ENTER dispara busca
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        buscar();
      }
    });

    // Auto-busca quando digitar c√≥digo completo (debounce)
    input.addEventListener("input", (e) => {
      const codigo = e.target.value.replace(/\D/g, "");

      if (buscaTimeout) clearTimeout(buscaTimeout);

      // Auto-busca se tiver 8+ d√≠gitos (c√≥digo de barras comum)
      if (codigo.length >= 8 && codigo.length <= 14) {
        buscaTimeout = setTimeout(() => {
          // S√≥ buscar se o c√≥digo for diferente do √∫ltimo buscado
          if (codigo !== ultimaBusca) {
            buscar();
          }
        }, 500); // Reduzido de 800ms para 500ms para busca mais r√°pida
      }
    });

    document.getElementById("buscar").onclick = buscar;

    function mostrarProduto(produto, origem, fonte) {
      let infoHTML = '';
      // Garantir que o c√≥digo de barras est√° sempre dispon√≠vel
      const codigo = produto['cod de barra'] || produto['cod. de barra'] || produto.codigo || input.value.replace(/\D/g, "");

      // Badge de fonte
      let fonteBadgeClass = 'local';
      if (origem === 'online') fonteBadgeClass = 'online';
      else if (origem === 'cache') fonteBadgeClass = 'cache';

      const fonteTexto = fonte || (origem === 'local' ? 'Base Local' : origem === 'online' ? 'Online' : 'Cache');
      const fonteBadge = `<span class="fonte-badge ${fonteBadgeClass}">${fonteTexto}</span>`;

      // Mostrar todas as informa√ß√µes do produto
      for (const [key, value] of Object.entries(produto)) {
        if (value && key !== 'cod de barra' && key !== 'cod. de barra' && key !== 'codigo' && key !== 'produto' && key !== 'nome' && key !== 'foto' && key !== 'fonte') {
          const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
          infoHTML += `<p><b>${label}:</b> ${value}</p>`;
        }
      }

      // Adicionar imagem se existir
      let imagemHTML = '';
      if (produto.foto) {
        console.log('üì∏ Foto do produto:', produto.foto);
        console.log('üì∏ Tipo da foto:', typeof produto.foto);
        // produto.foto pode ser um objeto {fonte, url, filename} ou uma string
        let fotoUrl = '';
        if (typeof produto.foto === 'object' && produto.foto.url) {
          fotoUrl = produto.foto.url;
          console.log('üì∏ URL da foto (objeto):', fotoUrl);
        } else if (typeof produto.foto === 'string') {
          fotoUrl = `/fotos/${produto.foto}`;
          console.log('üì∏ URL da foto (string):', fotoUrl);
        }

        if (fotoUrl) {
          // Escapar aspas no nome do produto para n√£o quebrar o HTML
          const altText = (produto.produto || produto.nome || 'Produto').replace(/"/g, '&quot;');
          const fotoUrlEscaped = fotoUrl.replace(/'/g, "\\'");
          imagemHTML = `<img src="${fotoUrl}" class="produto-imagem" alt="${altText}" onclick="abrirImagemModal('${fotoUrlEscaped}')" onerror="console.error('Erro ao carregar foto:', this.src); this.style.display='none';">`;
          console.log('üì∏ Imagem HTML gerado com sucesso');
        }
      } else {
        console.log('‚ö†Ô∏è Nenhuma foto dispon√≠vel para o produto');
      }

      resultado.innerHTML = `
        <div class="produto-card">
          ${fonteBadge}
          ${imagemHTML}
          <h3>${produto.produto || produto.nome || 'Produto Encontrado'}</h3>
          <div class="produto-info">
            <p><b>C√≥digo de Barras:</b> ${codigo}</p>
            ${infoHTML}
          </div>
        </div>
      `;
    }

    async function buscar() {
      const codigo = input.value.replace(/\D/g, "");

      if (!codigo) {
        resultado.innerHTML = "<p style='color: #999; margin-top: 20px;'>Digite um c√≥digo v√°lido.</p>";
        ultimaBusca = "";
        return;
      }

      // Evitar buscas duplicadas do mesmo c√≥digo
      if (codigo === ultimaBusca) {
        console.log("‚ö†Ô∏è C√≥digo j√° buscado, ignorando busca duplicada");
        return;
      }

      // Atualizar ultimaBusca ANTES da busca para evitar duplicatas em requisi√ß√µes r√°pidas
      ultimaBusca = codigo;
      resultado.innerHTML = `<p style='margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;'>
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="animation: pulse 1s ease-in-out infinite;">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        Buscando...
      </p>
      <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
      </style>`;

      try {
        console.log("üîç Iniciando busca para c√≥digo:", codigo);
        const resp = await fetch(`/consulta/${codigo}`);
        const data = await resp.json();

        console.log("üì¶ Resposta recebida:", data);
        console.log("üì¶ Produto:", data.produto);
        console.log("üì¶ Foto no produto:", data.produto?.foto);

        if (!data.ok) {
          resultado.innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-radius: 10px; color: #c62828;">
              <strong>‚ùå Produto n√£o encontrado</strong>
              <p style="margin: 5px 0 0 0; font-size: 14px;">C√≥digo: ${codigo}</p>
            </div>
          `;
          return;
        }

        console.log("‚úÖ Produto encontrado! Origem:", data.origem);
        mostrarProduto(data.produto, data.origem, data.fonte);
      } catch (error) {
        console.error("‚ùå Erro na busca:", error);
        resultado.innerHTML = `
          <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 10px; color: #e65100;">
            <strong>‚ö†Ô∏è Erro de conex√£o</strong>
            <p style="margin: 5px 0 0 0; font-size: 14px;">Verifique sua internet e tente novamente.</p>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">${error.message}</p>
          </div>
        `;
        // Resetar ultimaBusca em caso de erro para permitir nova tentativa
        ultimaBusca = "";
      }
    }

    // SCANNER DE C√ÇMERA - Usando html5-qrcode (solu√ß√£o profissional)
    document.getElementById("scanner").onclick = async () => {
      try {
        scannerContainer.classList.add('active');
        scanStatus.textContent = "Iniciando c√¢mera...";
        scanStatus.style.background = "rgba(0, 0, 0, 0.8)";

        // Criar inst√¢ncia do scanner se n√£o existir
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("scanner-reader");
        }

        // Configura√ß√£o otimizada para leitura r√°pida de c√≥digos de barras
        const config = {
          fps: 15, // Frames por segundo para detec√ß√£o
          qrbox: { width: 300, height: 150 }, // √Årea de leitura retangular (ideal para c√≥digos de barras)
          aspectRatio: 1.777778, // 16:9
          formatsToSupport: [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.ITF,
            Html5QrcodeSupportedFormats.QR_CODE
          ],
          experimentalFeatures: {
            useBarCodeDetectorIfSupported: true // Usa API nativa quando dispon√≠vel (mais r√°pido)
          }
        };

        // Callback quando c√≥digo √© detectado
        const onScanSuccess = (decodedText, decodedResult) => {
          console.log(`‚úÖ C√≥digo detectado: ${decodedText}`);

          // Vibrar dispositivo
          if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100]);
          }

          // Som de sucesso
          try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 1200;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.15);
          } catch (e) {}

          input.value = decodedText;
          clearButton.classList.add('visible');
          scanStatus.textContent = "‚úì C√≥digo detectado!";
          scanStatus.style.background = "rgba(76, 175, 80, 0.9)";

          // Fechar scanner e buscar
          setTimeout(() => {
            fecharScanner();
            buscar();
          }, 400);
        };

        // Callback de erro (ignorar erros de leitura normais)
        const onScanError = (errorMessage) => {
          // Erros normais de frames sem c√≥digo - ignorar silenciosamente
        };

        // Obter c√¢mera traseira (preferencial) com alta resolu√ß√£o
        const cameras = await Html5Qrcode.getCameras();

        if (!cameras || cameras.length === 0) {
          throw new Error('Nenhuma c√¢mera encontrada');
        }

        // Preferir c√¢mera traseira
        let cameraId = cameras[0].id;
        for (const camera of cameras) {
          const label = camera.label.toLowerCase();
          if (label.includes('back') || label.includes('traseira') || label.includes('rear') || label.includes('environment')) {
            cameraId = camera.id;
            break;
          }
        }

        // Iniciar scanner
        await html5QrCode.start(
          cameraId,
          config,
          onScanSuccess,
          onScanError
        );

        isScanning = true;
        scanStatus.textContent = "Posicione o c√≥digo de barras na √°rea de leitura";

        // Tentar aplicar zoom e foco cont√≠nuo (se dispon√≠vel)
        try {
          const videoElement = document.querySelector('#scanner-reader video');
          if (videoElement && videoElement.srcObject) {
            const track = videoElement.srcObject.getVideoTracks()[0];
            const capabilities = track.getCapabilities();

            const advancedConstraints = [];

            // Aplicar foco cont√≠nuo
            if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
              advancedConstraints.push({ focusMode: 'continuous' });
            }

            // Aplicar zoom leve para melhor leitura (se dispon√≠vel)
            if (capabilities.zoom && capabilities.zoom.max > 1) {
              const optimalZoom = Math.min(1.5, capabilities.zoom.max);
              advancedConstraints.push({ zoom: optimalZoom });
            }

            if (advancedConstraints.length > 0) {
              await track.applyConstraints({ advanced: advancedConstraints });
              console.log('üì∑ Configura√ß√µes de c√¢mera aplicadas:', advancedConstraints);
            }
          }
        } catch (e) {
          console.log('‚ö†Ô∏è N√£o foi poss√≠vel aplicar configura√ß√µes avan√ßadas de c√¢mera');
        }

      } catch (err) {
        console.error('‚ùå Erro ao acessar c√¢mera:', err);

        let mensagem = 'N√£o foi poss√≠vel acessar a c√¢mera.';
        if (err.name === 'NotAllowedError') {
          mensagem = 'Permiss√£o de c√¢mera negada. Permita o acesso nas configura√ß√µes do navegador.';
        } else if (err.name === 'NotFoundError' || err.message.includes('Nenhuma c√¢mera')) {
          mensagem = 'Nenhuma c√¢mera encontrada no dispositivo.';
        } else if (err.name === 'NotReadableError') {
          mensagem = 'C√¢mera em uso por outro aplicativo.';
        }

        alert(mensagem);
        fecharScanner();
      }
    };

    document.getElementById("close-scanner").onclick = fecharScanner;

    // Fechar scanner ao pressionar ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && scannerContainer.classList.contains('active')) {
        fecharScanner();
      }
    });

    async function fecharScanner() {
      if (html5QrCode && isScanning) {
        try {
          await html5QrCode.stop();
        } catch (e) {
          console.log('Erro ao parar scanner:', e);
        }
        isScanning = false;
      }
      scannerContainer.classList.remove('active');
      scanStatus.textContent = "Posicione o c√≥digo de barras na √°rea de leitura";
      scanStatus.style.background = "rgba(0, 0, 0, 0.8)";
    }

    // ========================================
    // TOGGLE PESAGEM E BLUETOOTH
    // ========================================
    const togglePesagem = document.getElementById('toggle-pesagem');
    const pesoContainer = document.getElementById('peso-container');
    const pesoInput = document.getElementById('peso');
    const conectarBalancaBtn = document.getElementById('conectar-balanca');
    const bluetoothStatus = document.getElementById('bluetooth-status');
    const quantidadeInput = document.getElementById('quantidade');
    const salvarInventarioBtn = document.getElementById('salvar-inventario');

    let bluetoothDevice = null;
    let bluetoothCharacteristic = null;
    let produtoAtual = null;

    // Toggle mostrar/esconder campo de peso
    togglePesagem.addEventListener('change', () => {
      if (togglePesagem.checked) {
        pesoContainer.classList.add('visible');
      } else {
        pesoContainer.classList.remove('visible');
        // Desconectar balan√ßa se estiver conectada
        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
          bluetoothDevice.gatt.disconnect();
        }
        pesoInput.value = '';
        ultimoPesoRecebido = 0;
        // Resetar vari√°veis de estabiliza√ß√£o (ser√£o definidas depois)
      }
    });

    let pollingInterval = null;
    let allCharacteristics = [];
    let ultimoPesoRecebido = 0;
    let ultimaAtualizacaoStatus = 0;

    // Conectar Balan√ßa Bluetooth (Electrolux Kitchen Scale GKS.1136 BT)
    conectarBalancaBtn.addEventListener('click', async () => {
      try {
        // Verificar se Bluetooth est√° dispon√≠vel no navegador
        if (typeof navigator === 'undefined' || !navigator.bluetooth || typeof navigator.bluetooth.requestDevice !== 'function') {
          bluetoothStatus.innerHTML = '<strong>Bluetooth n√£o suportado</strong><br><small>Web Bluetooth s√≥ funciona em:<br>‚Ä¢ Chrome no Android<br>‚Ä¢ Chrome/Edge no computador<br><br>N√ÉO funciona em Safari ou iOS.</small>';
          bluetoothStatus.style.color = '#f44336';
          return;
        }

        bluetoothStatus.textContent = 'Procurando balan√ßa... Selecione na lista que aparecer.';
        bluetoothStatus.style.color = '#666';

        // Servi√ßos comuns de balan√ßas
        const knownServices = [
          '0000181d-0000-1000-8000-00805f9b34fb', // Weight Scale Service
          '0000181b-0000-1000-8000-00805f9b34fb', // Body Composition Service
          '0000fff0-0000-1000-8000-00805f9b34fb', // Custom Service (comum em balan√ßas chinesas)
          '0000ffe0-0000-1000-8000-00805f9b34fb', // Custom Service 2
          '0000fee7-0000-1000-8000-00805f9b34fb', // Tencent service
          '00001800-0000-1000-8000-00805f9b34fb', // Generic Access
          '00001801-0000-1000-8000-00805f9b34fb', // Generic Attribute
          'battery_service'
        ];

        bluetoothDevice = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: knownServices
        });

        bluetoothStatus.textContent = 'Conectando...';
        const server = await bluetoothDevice.gatt.connect();

        // Obter todos os servi√ßos dispon√≠veis
        const services = await server.getPrimaryServices();
        console.log('üîß Servi√ßos encontrados:', services.length);

        allCharacteristics = [];

        // Explorar todos os servi√ßos e caracter√≠sticas
        for (const service of services) {
          console.log('üì¶ Servi√ßo:', service.uuid);
          try {
            const chars = await service.getCharacteristics();
            for (const char of chars) {
              console.log('  üìã Caracter√≠stica:', char.uuid, '| Propriedades:',
                Object.keys(char.properties).filter(k => char.properties[k]).join(', '));
              allCharacteristics.push(char);

              // Inscrever em todas as caracter√≠sticas que suportam notify/indicate
              if (char.properties.notify || char.properties.indicate) {
                try {
                  if (char.properties.notify) {
                    await char.startNotifications();
                  }
                  char.addEventListener('characteristicvaluechanged', handleWeightData);
                  console.log('  ‚úÖ Inscrito em notifica√ß√µes');
                } catch (e) {
                  console.log('  ‚ö†Ô∏è N√£o foi poss√≠vel inscrever:', e.message);
                }
              }
            }
          } catch (e) {
            console.log('  ‚ö†Ô∏è Erro ao ler caracter√≠sticas:', e.message);
          }
        }

        // Tamb√©m fazer polling (leitura peri√≥dica) para balan√ßas que n√£o enviam notifica√ß√µes
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(async () => {
          for (const char of allCharacteristics) {
            if (char.properties.read) {
              try {
                const value = await char.readValue();
                // Simular evento de mudan√ßa
                handleWeightData({ target: { value } });
              } catch (e) {
                // Ignorar erros de leitura
              }
            }
          }
        }, 500); // Ler a cada 500ms

        // Atualizar UI
        conectarBalancaBtn.classList.add('connected');
        bluetoothStatus.textContent = 'Balan√ßa conectada! Coloque o produto na balan√ßa...';
        bluetoothStatus.style.color = '#4CAF50';

        // Monitorar desconex√£o
        bluetoothDevice.addEventListener('gattserverdisconnected', () => {
          conectarBalancaBtn.classList.remove('connected');
          bluetoothStatus.textContent = 'Balan√ßa desconectada. Clique para reconectar.';
          bluetoothStatus.style.color = '#f44336';
          pesoInput.value = '';
          ultimoPesoRecebido = 0;
          pesoEstavel = 0;
          pesoConfirmado = false;
          ultimoPesoConfirmado = 0;
          if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
          }
        });

      } catch (error) {
        console.error('Erro Bluetooth:', error);

        let mensagem = 'Erro ao conectar √† balan√ßa.';
        if (error.name === 'NotFoundError') {
          mensagem = 'Nenhuma balan√ßa encontrada. Certifique-se que est√° ligada e pareada no Bluetooth do celular.';
        } else if (error.name === 'SecurityError') {
          mensagem = 'Permiss√£o Bluetooth negada. Verifique as configura√ß√µes do navegador.';
        } else if (error.name === 'NotSupportedError') {
          mensagem = 'Bluetooth n√£o suportado neste navegador. Use Chrome no Android.';
        } else if (error.name === 'TypeError' && error.message.includes('bluetooth')) {
          mensagem = 'Bluetooth n√£o dispon√≠vel. Use Chrome/Edge no Android ou computador.';
        } else if (error.message && error.message.includes('User cancelled')) {
          mensagem = 'Sele√ß√£o cancelada. Clique novamente para conectar.';
          bluetoothStatus.style.color = '#666';
          return;
        } else if (error.message) {
          mensagem = error.message;
        }

        bluetoothStatus.innerHTML = mensagem + '<br><small>Dica: Pareie a balan√ßa primeiro nas Configura√ß√µes Bluetooth do celular.</small>';
        bluetoothStatus.style.color = '#f44336';
      }
    });

    // Vari√°veis para estabiliza√ß√£o do peso
    let pesoEstavel = 0;
    let tempoInicioEstabilizacao = 0;
    let pesoConfirmado = false;
    let ultimoPesoConfirmado = 0;
    const TEMPO_ESTABILIZACAO = 2000; // 2 segundos
    const TOLERANCIA_PESO = 0.005; // 5 gramas de toler√¢ncia
    const TOLERANCIA_MUDANCA = 0.010; // 10 gramas para detectar mudan√ßa ap√≥s confirma√ß√£o
    const PESO_MAXIMO = 10; // 10kg m√°ximo (balan√ßa de cozinha)

    // Processar dados de peso da balan√ßa
    function handleWeightData(event) {
      const value = event.target.value;
      const data = new Uint8Array(value.buffer);

      // Debug apenas no console
      const hexString = Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ');
      console.log('üìä Dados da balan√ßa:', hexString);

      let peso = 0;
      let pesoEncontrado = false;

      // M√©todo 1: Peso direto em gramas (2 bytes, little-endian) - mais comum
      if (data.length >= 2 && !pesoEncontrado) {
        const pesoGramas = (data[1] << 8) | data[0];
        if (pesoGramas > 0 && pesoGramas <= PESO_MAXIMO * 1000) {
          peso = pesoGramas / 1000;
          pesoEncontrado = true;
        }
      }

      // M√©todo 2: Peso com flag no primeiro byte
      if (data.length >= 3 && !pesoEncontrado) {
        const pesoGramas = (data[2] << 8) | data[1];
        if (pesoGramas > 0 && pesoGramas <= PESO_MAXIMO * 1000) {
          peso = pesoGramas / 1000;
          pesoEncontrado = true;
        }
      }

      // M√©todo 3: Big-endian
      if (data.length >= 2 && !pesoEncontrado) {
        const pesoGramas = (data[0] << 8) | data[1];
        if (pesoGramas > 0 && pesoGramas <= PESO_MAXIMO * 1000) {
          peso = pesoGramas / 1000;
          pesoEncontrado = true;
        }
      }

      // M√©todo 4: Texto ASCII
      if (!pesoEncontrado) {
        try {
          const texto = new TextDecoder().decode(data);
          const match = texto.match(/(\d+[.,]?\d*)/);
          if (match) {
            const pesoTexto = parseFloat(match[1].replace(',', '.'));
            if (pesoTexto > 0 && pesoTexto <= PESO_MAXIMO) {
              peso = pesoTexto;
              pesoEncontrado = true;
            }
          }
        } catch (e) {}
      }

      // Atualizar campo se peso v√°lido encontrado
      if (pesoEncontrado && peso > 0 && peso <= PESO_MAXIMO) {
        const agora = Date.now();

        // Se j√° confirmou, verificar se o peso mudou significativamente (mexeu na balan√ßa)
        if (pesoConfirmado) {
          if (Math.abs(peso - ultimoPesoConfirmado) > TOLERANCIA_MUDANCA) {
            // Peso mudou ap√≥s confirma√ß√£o - voltar a medir!
            pesoConfirmado = false;
            pesoEstavel = peso;
            tempoInicioEstabilizacao = agora;
            pesoInput.value = peso.toFixed(3);
            bluetoothStatus.textContent = `Peso: ${peso.toFixed(3)} kg (aguardando estabilizar...)`;
            bluetoothStatus.style.color = '#666';
          } else {
            // Peso ainda est√°vel ap√≥s confirma√ß√£o - manter confirmado mas atualizar display
            pesoInput.value = peso.toFixed(3);
          }
        } else {
          // Ainda n√£o confirmou - verificar estabiliza√ß√£o
          if (Math.abs(peso - pesoEstavel) <= TOLERANCIA_PESO) {
            // Peso est√°vel - verificar tempo
            const tempoEstavel = agora - tempoInicioEstabilizacao;

            if (tempoEstavel >= TEMPO_ESTABILIZACAO) {
              // Peso est√°vel por 2 segundos - CONFIRMAR!
              pesoConfirmado = true;
              ultimoPesoConfirmado = peso;
              pesoInput.value = peso.toFixed(3);
              bluetoothStatus.innerHTML = `<strong>Peso confirmado: ${peso.toFixed(3)} kg</strong>`;
              bluetoothStatus.style.color = '#4CAF50';
              atualizarBotaoSalvar();

              // Feedback visual e sonoro
              try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
              } catch (e) {}

              if (navigator.vibrate) navigator.vibrate(200);

            } else {
              // Ainda estabilizando - mostrar progresso
              const progresso = Math.min(100, (tempoEstavel / TEMPO_ESTABILIZACAO) * 100);
              pesoInput.value = peso.toFixed(3);
              bluetoothStatus.textContent = `Estabilizando... ${progresso.toFixed(0)}%`;
              bluetoothStatus.style.color = '#FF9800';
            }
          } else {
            // Peso mudou - resetar estabiliza√ß√£o
            pesoEstavel = peso;
            tempoInicioEstabilizacao = agora;
            pesoInput.value = peso.toFixed(3);
            bluetoothStatus.textContent = `Peso: ${peso.toFixed(3)} kg (aguardando estabilizar...)`;
            bluetoothStatus.style.color = '#666';
          }
        }

        ultimoPesoRecebido = peso;
      }
      // N√£o mostrar nada na tela se n√£o encontrar peso v√°lido
    }

    // ========================================
    // SALVAR NO INVENT√ÅRIO
    // ========================================

    // Atualizar estado do bot√£o salvar
    function atualizarBotaoSalvar() {
      const codigo = input.value.replace(/\D/g, "");
      const quantidade = parseInt(quantidadeInput.value) || 0;

      if (codigo && quantidade > 0) {
        salvarInventarioBtn.disabled = false;
      } else {
        salvarInventarioBtn.disabled = true;
      }
    }

    // Monitorar mudan√ßas
    input.addEventListener('input', atualizarBotaoSalvar);
    quantidadeInput.addEventListener('input', atualizarBotaoSalvar);

    // Sobrescrever fun√ß√£o mostrarProduto para guardar produto atual
    const originalMostrarProduto = mostrarProduto;
    mostrarProduto = function(produto, origem, fonte) {
      produtoAtual = produto;
      originalMostrarProduto(produto, origem, fonte);
      atualizarBotaoSalvar();
    };

    // ========================================
    // BUSCA POR NOME COM AUTOCOMPLETE
    // ========================================
    const buscaNomeInput = document.getElementById('busca-nome');
    const clearBuscaNomeBtn = document.getElementById('clear-busca-nome');
    const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
    let buscaNomeTimeout = null;

    // Mostrar/esconder bot√£o X da busca por nome
    buscaNomeInput.addEventListener('input', () => {
      if (buscaNomeInput.value.length > 0) {
        clearBuscaNomeBtn.classList.add('visible');
      } else {
        clearBuscaNomeBtn.classList.remove('visible');
        autocompleteDropdown.classList.remove('visible');
      }

      // Debounce para busca
      if (buscaNomeTimeout) clearTimeout(buscaNomeTimeout);

      if (buscaNomeInput.value.length >= 2) {
        buscaNomeTimeout = setTimeout(() => {
          buscarPorNome(buscaNomeInput.value);
        }, 300);
      } else {
        autocompleteDropdown.classList.remove('visible');
      }
    });

    // Limpar busca por nome
    clearBuscaNomeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      buscaNomeInput.value = '';
      clearBuscaNomeBtn.classList.remove('visible');
      autocompleteDropdown.classList.remove('visible');
      buscaNomeInput.focus();
    });

    // Buscar produtos por nome
    async function buscarPorNome(termo) {
      try {
        const resp = await fetch(`/api/buscar-por-nome/${encodeURIComponent(termo)}`);
        const data = await resp.json();

        if (data.ok && data.produtos.length > 0) {
          autocompleteDropdown.innerHTML = data.produtos.map(p => `
            <div class="autocomplete-item" data-codigo="${p.codigo}" data-nome="${p.nome}">
              <div class="autocomplete-item-nome">${p.nome}</div>
              <div class="autocomplete-item-codigo">C√≥digo: ${p.codigo}</div>
            </div>
          `).join('');
          autocompleteDropdown.classList.add('visible');

          // Adicionar eventos de clique
          autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', () => {
              const codigo = item.dataset.codigo;
              const nome = item.dataset.nome;

              // Preencher o c√≥digo de barras e buscar
              input.value = codigo;
              clearButton.classList.add('visible');
              buscaNomeInput.value = nome;
              autocompleteDropdown.classList.remove('visible');

              // Buscar o produto
              buscar();
            });
          });
        } else {
          autocompleteDropdown.innerHTML = '<div class="autocomplete-item"><div class="autocomplete-item-nome" style="color: #999;">Nenhum produto encontrado</div></div>';
          autocompleteDropdown.classList.add('visible');
        }
      } catch (error) {
        console.error('Erro ao buscar por nome:', error);
        autocompleteDropdown.classList.remove('visible');
      }
    }

    // Fechar dropdown ao clicar fora
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.busca-nome-container')) {
        autocompleteDropdown.classList.remove('visible');
      }
    });

    // Salvar no invent√°rio
    salvarInventarioBtn.addEventListener('click', async () => {
      const codigo = input.value.replace(/\D/g, "");
      const quantidade = parseInt(quantidadeInput.value) || 1;
      const peso = pesoInput.value || '';

      if (!codigo) {
        alert('Digite ou escaneie um c√≥digo de barras.');
        return;
      }

      const dadosInventario = {
        codigo: codigo,
        produto: produtoAtual?.produto || produtoAtual?.nome || '',
        quantidade: quantidade,
        peso: peso,
        dataHora: new Date().toISOString()
      };

      try {
        salvarInventarioBtn.disabled = true;
        salvarInventarioBtn.innerHTML = `
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          Salvando...
        `;

        const resp = await fetch('/api/inventario', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dadosInventario)
        });

        const result = await resp.json();

        if (result.ok) {
          const textoSucesso = result.atualizado ? 'Quantidade atualizada!' : 'Salvo com sucesso!';
          salvarInventarioBtn.innerHTML = `
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
            ${textoSucesso}
          `;
          salvarInventarioBtn.style.background = result.atualizado ? '#2196F3' : '#4CAF50';

          // Resetar ap√≥s 2 segundos
          setTimeout(() => {
            salvarInventarioBtn.innerHTML = `
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                <polyline points="17,21 17,13 7,13 7,21"/>
                <polyline points="7,3 7,8 15,8"/>
              </svg>
              Salvar no Invent√°rio
            `;
            salvarInventarioBtn.style.background = '#000000';
            salvarInventarioBtn.disabled = false;

            // Limpar campos para pr√≥ximo produto
            quantidadeInput.value = '1';
          }, 2000);
        } else {
          throw new Error(result.error || 'Erro ao salvar');
        }
      } catch (error) {
        console.error('Erro ao salvar invent√°rio:', error);
        alert('Erro ao salvar no invent√°rio: ' + error.message);

        salvarInventarioBtn.innerHTML = `
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
            <polyline points="17,21 17,13 7,13 7,21"/>
            <polyline points="7,3 7,8 15,8"/>
          </svg>
          Salvar no Invent√°rio
        `;
        salvarInventarioBtn.disabled = false;
      }
    });


  </script>
</body>
</html>