<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>MISE - Scanner</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #66F7CC;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px 20px 40px 20px;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: transparent;
      border-radius: 20px;
      padding: 0;
      text-align: center;
      overflow: hidden;
    }

    .form-content {
      padding: 25px;
    }

    h2 {
      margin-top: 5px;
      font-weight: bold;
      color: #222;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      margin-top: 10px;
    }

    input {
      width: 100%;
      padding: 12px 45px 12px 12px;
      border: 2px solid #000;
      border-radius: 10px;
      font-size: 18px;
      text-align: center;
      box-sizing: border-box;
      -moz-appearance: textfield;
      background: transparent;
    }

    input::placeholder {
      color: #333;
    }

    /* Toggle Switch */
    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 15px;
      padding: 12px 15px;
      border: 2px solid #000;
      border-radius: 10px;
      background: transparent;
    }

    .toggle-label {
      font-size: 14px;
      font-weight: 600;
      color: #222;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: #6a5acd;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Campos de Peso e Quantidade */
    .peso-container {
      display: none;
      margin-top: 10px;
    }

    .peso-container.visible {
      display: block;
    }

    .peso-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .peso-input {
      flex: 1;
    }

    .bluetooth-btn {
      width: 50px;
      height: 50px;
      min-width: 50px;
      padding: 0;
      margin: 0;
      border-radius: 10px;
      background: #6a5acd;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .bluetooth-btn:hover {
      background: #5a4abd;
    }

    .bluetooth-btn.connected {
      background: #4CAF50;
    }

    .bluetooth-btn svg {
      width: 24px;
      height: 24px;
    }

    .quantidade-container {
      margin-top: 10px;
    }

    /* Label para campos */
    .field-label {
      display: block;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      margin-left: 5px;
    }

    /* Bot√£o Salvar Invent√°rio */
    #salvar-inventario {
      background: #000000;
      color: white;
      margin-top: 10px;
    }

    #salvar-inventario:disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
    }

    #salvar-inventario:not(:disabled):hover {
      background: #333;
    }

    /* Header com Logo */
    .header-logo {
      text-align: center;
      margin-bottom: 10px;
    }

    .header-logo img {
      max-width: 150px;
      height: auto;
    }

    .header-slogan {
      font-size: 14px;
      color: #222;
      font-weight: 500;
      margin-top: 5px;
    }

    .clear-button {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      color: #999;
      border: none;
      width: 20px;
      height: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      line-height: 20px;
      padding: 0;
      margin: 0;
      transition: all 0.2s;
      font-family: Arial, sans-serif;
      font-weight: bold;
      text-align: center;
      vertical-align: middle;
    }

    .clear-button:hover {
      color: #666;
      transform: translateY(-50%) scale(1.1);
    }

    .clear-button.visible {
      display: flex;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      margin-top: 15px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
    }

    #buscar {
      background: #66F7CC;
      color: #222;
    }

    #scanner {
      background: #6a5acd;
      color: white;
    }

    button svg {
      width: 20px;
      height: 20px;
    }

    .produto-card {
      background: #f2f2f2;
      margin-top: 20px;
      padding: 18px;
      border-radius: 12px;
      text-align: left;
    }

    .produto-card h3 {
      margin: 0;
      font-size: 20px;
    }

    .produto-info {
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.8;
    }

    .produto-info p {
      margin: 8px 0;
    }

    #video-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #video-container.active {
      display: flex;
    }

    .camera-wrapper {
      position: relative;
      width: 95%;
      max-width: 700px;
      aspect-ratio: 4/3;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(102, 247, 204, 0.3);
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #close-camera {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      color: #66F7CC;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
    }

    .scanner-frame {
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 450px;
      aspect-ratio: 2/1;
      border: 4px solid #66F7CC;
      border-radius: 15px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }

    .scanner-line {
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 86%;
      max-width: 430px;
      height: 4px;
      background: linear-gradient(90deg, transparent, #66F7CC, transparent);
      box-shadow: 0 0 15px #66F7CC, 0 0 30px #66F7CC;
      animation: scan 2s ease-in-out infinite;
      pointer-events: none;
    }

    .produto-imagem {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 12px;
      margin: 15px auto;
      display: block;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .produto-imagem:hover {
      transform: scale(1.02);
    }

    #image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #image-modal.active {
      display: flex;
    }

    #modal-image {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(102, 247, 204, 0.5);
    }

    #close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      color: #333;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      z-index: 2001;
    }

    @keyframes scan {
      0%, 100% {
        transform: translate(-50%, -50%) translateY(-80px);
        opacity: 0.3;
      }
      50% {
        transform: translate(-50%, -50%) translateY(80px);
        opacity: 1;
      }
    }

    .scan-status {
      position: absolute;
      bottom: 8%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #66F7CC;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
    }

  </style>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>

<body>

  <div class="container">

    <div class="form-content">
      <!-- Logo e Slogan -->
      <div class="header-logo">
        <img src="/logo-mise.png" alt="MISE" onerror="this.style.display='none'">
        <p class="header-slogan">Prepara para o sucesso</p>
      </div>

      <h2>Scanner de C√≥digos de Barras</h2>

      <!-- INPUT C√ìDIGO DE BARRAS -->
      <div class="input-wrapper">
        <input
            id="codigo"
            type="text"
            placeholder="Digite ou escaneie o c√≥digo"
            inputmode="numeric"
            pattern="[0-9]*"
        />
        <button class="clear-button" id="clear-button">‚úï</button>
      </div>

      <!-- TOGGLE PESAGEM -->
      <div class="toggle-container">
        <span class="toggle-label">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
          Balan√ßa Bluetooth
        </span>
        <label class="toggle-switch">
          <input type="checkbox" id="toggle-pesagem">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <!-- CAMPO DE PESO (vis√≠vel quando toggle ativo) -->
      <div class="peso-container" id="peso-container">
        <label class="field-label">Peso (kg)</label>
        <div class="peso-wrapper">
          <div class="input-wrapper peso-input">
            <input
                id="peso"
                type="text"
                placeholder="0.000"
                inputmode="decimal"
            />
          </div>
          <button class="bluetooth-btn" id="conectar-balanca" title="Conectar Balan√ßa Bluetooth">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
            </svg>
          </button>
        </div>
        <p id="bluetooth-status" style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Digite o peso ou clique no √≠cone para conectar a balan√ßa</p>
      </div>

      <!-- CAMPO DE QUANTIDADE -->
      <div class="quantidade-container">
        <label class="field-label">Quantidade</label>
        <div class="input-wrapper">
          <input
              id="quantidade"
              type="number"
              placeholder="1"
              min="1"
              value="1"
          />
        </div>
      </div>

      <button id="buscar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        Buscar na base mise
      </button>

      <button id="scanner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        Scanner
      </button>

      <!-- BOT√ÉO SALVAR INVENT√ÅRIO -->
      <button id="salvar-inventario" disabled>
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
          <polyline points="17,21 17,13 7,13 7,21"/>
          <polyline points="7,3 7,8 15,8"/>
        </svg>
        Salvar no Invent√°rio
      </button>

      <div id="resultado"></div>
    </div>
  </div>

  <!-- CONTAINER DA C√ÇMERA -->
  <div id="video-container">
    <button id="close-camera">‚úï Fechar</button>
    <div class="camera-wrapper">
      <video id="video" playsinline></video>
      <div class="scanner-frame"></div>
      <div class="scanner-line"></div>
      <div class="scan-status">Posicione o c√≥digo de barras no centro</div>
    </div>
  </div>

  <!-- MODAL PARA FOTO EM TAMANHO GRANDE -->
  <div id="image-modal">
    <button id="close-modal">‚úï Fechar</button>
    <img id="modal-image" src="" alt="Produto">
  </div>

  <script>
    const input = document.getElementById("codigo");
    const resultado = document.getElementById("resultado");
    const videoContainer = document.getElementById("video-container");
    const video = document.getElementById("video");
    const imageModal = document.getElementById("image-modal");
    const modalImage = document.getElementById("modal-image");
    const scanStatus = document.querySelector(".scan-status");
    const clearButton = document.getElementById("clear-button");
    let codeReader = null;
    let stream = null;
    let ultimaBusca = "";
    let buscaTimeout = null;

    // LIMPAR INPUT AO CLICAR NELE
    input.addEventListener('click', () => {
      input.value = '';
      clearButton.classList.remove('visible');
      resultado.innerHTML = '';
      ultimaBusca = '';
    });

    // MOSTRAR/ESCONDER BOT√ÉO X
    input.addEventListener('input', () => {
      if (input.value.length > 0) {
        clearButton.classList.add('visible');
      } else {
        clearButton.classList.remove('visible');
      }
    });

    // LIMPAR INPUT AO CLICAR NO X
    clearButton.addEventListener('click', (e) => {
      e.preventDefault();
      input.value = '';
      clearButton.classList.remove('visible');
      resultado.innerHTML = '';
      ultimaBusca = '';
      input.focus();
    });

    // MODAL DE IMAGEM
    function abrirImagemModal(src) {
      modalImage.src = src;
      imageModal.classList.add('active');
    }

    function fecharImagemModal() {
      imageModal.classList.remove('active');
      modalImage.src = '';
    }

    document.getElementById("close-modal").onclick = fecharImagemModal;
    imageModal.onclick = (e) => {
      if (e.target === imageModal) {
        fecharImagemModal();
      }
    };

    // ENTER dispara busca
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        buscar();
      }
    });

    // Auto-busca quando digitar c√≥digo completo (debounce)
    input.addEventListener("input", (e) => {
      const codigo = e.target.value.replace(/\D/g, "");

      if (buscaTimeout) clearTimeout(buscaTimeout);

      // Auto-busca se tiver 8+ d√≠gitos (c√≥digo de barras comum)
      if (codigo.length >= 8 && codigo.length <= 14) {
        buscaTimeout = setTimeout(() => {
          // S√≥ buscar se o c√≥digo for diferente do √∫ltimo buscado
          if (codigo !== ultimaBusca) {
            buscar();
          }
        }, 500); // Reduzido de 800ms para 500ms para busca mais r√°pida
      }
    });

    document.getElementById("buscar").onclick = buscar;

    function mostrarProduto(produto, origem) {
      let infoHTML = '';
      // Garantir que o c√≥digo de barras est√° sempre dispon√≠vel
      const codigo = produto['cod de barra'] || produto['cod. de barra'] || produto.codigo || input.value.replace(/\D/g, "");

      // Mostrar todas as informa√ß√µes do produto
      for (const [key, value] of Object.entries(produto)) {
        if (value && key !== 'cod de barra' && key !== 'cod. de barra' && key !== 'codigo' && key !== 'produto' && key !== 'nome' && key !== 'foto') {
          const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
          infoHTML += `<p><b>${label}:</b> ${value}</p>`;
        }
      }

      // Adicionar imagem se existir
      let imagemHTML = '';
      if (produto.foto) {
        console.log('üì∏ Foto do produto:', produto.foto);
        // produto.foto pode ser um objeto {fonte, url, filename} ou uma string
        let fotoUrl = '';
        if (typeof produto.foto === 'object' && produto.foto.url) {
          fotoUrl = produto.foto.url;
        } else if (typeof produto.foto === 'string') {
          fotoUrl = `/fotos/${produto.foto}`;
        }

        if (fotoUrl) {
          imagemHTML = `<img src="${fotoUrl}" class="produto-imagem" alt="${produto.produto || produto.nome}" onclick="abrirImagemModal('${fotoUrl}')" onerror="console.error('Erro ao carregar foto:', this.src); this.style.display='none';">`;
        }
      } else {
        console.log('‚ö†Ô∏è Nenhuma foto dispon√≠vel para o produto');
      }

      resultado.innerHTML = `
        <div class="produto-card">
          ${imagemHTML}
          <h3>${produto.produto || produto.nome || 'Produto Encontrado'}</h3>
          <div class="produto-info">
            <p><b>C√≥digo de Barras:</b> ${codigo}</p>
            ${infoHTML}
          </div>
        </div>
      `;
    }

    async function buscar() {
      const codigo = input.value.replace(/\D/g, "");

      if (!codigo) {
        resultado.innerHTML = "<p style='color: #999; margin-top: 20px;'>Digite um c√≥digo v√°lido.</p>";
        ultimaBusca = "";
        return;
      }

      // Evitar buscas duplicadas do mesmo c√≥digo
      if (codigo === ultimaBusca) {
        console.log("‚ö†Ô∏è C√≥digo j√° buscado, ignorando busca duplicada");
        return;
      }

      // Atualizar ultimaBusca ANTES da busca para evitar duplicatas em requisi√ß√µes r√°pidas
      ultimaBusca = codigo;
      resultado.innerHTML = "<p style='margin-top: 20px;'>üîç Buscando na base local...</p>";

      try {
        console.log("üîç Iniciando busca para c√≥digo:", codigo);
        const resp = await fetch(`/consulta/${codigo}`);
        const data = await resp.json();

        console.log("üì¶ Resposta recebida:", data);

        if (!data.ok) {
          resultado.innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-radius: 10px; color: #c62828;">
              <strong>‚ùå Produto n√£o encontrado</strong>
              <p style="margin: 5px 0 0 0; font-size: 14px;">C√≥digo: ${codigo}</p>
            </div>
          `;
          return;
        }

        console.log("‚úÖ Produto encontrado! Origem:", data.origem);
        mostrarProduto(data.produto, data.origem);
      } catch (error) {
        console.error("‚ùå Erro na busca:", error);
        resultado.innerHTML = `
          <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 10px; color: #e65100;">
            <strong>‚ö†Ô∏è Erro de conex√£o</strong>
            <p style="margin: 5px 0 0 0; font-size: 14px;">Verifique sua internet e tente novamente.</p>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">${error.message}</p>
          </div>
        `;
        // Resetar ultimaBusca em caso de erro para permitir nova tentativa
        ultimaBusca = "";
      }
    }

    // SCANNER DE C√ÇMERA
    document.getElementById("scanner").onclick = async () => {
      try {
        videoContainer.classList.add('active');
        scanStatus.textContent = "Iniciando c√¢mera...";

        codeReader = new ZXing.BrowserBarcodeReader();

        const constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        // Aguardar o v√≠deo carregar antes de iniciar
        await video.play();

        scanStatus.textContent = "Posicione o c√≥digo de barras no centro";

        // Decodificar c√≥digo de barras
        codeReader.decodeFromVideoDevice(null, video, (result, err) => {
          if (result) {
            // Som de sucesso (opcional, pode ser removido se n√£o quiser)
            try {
              const audioContext = new (window.AudioContext || window.webkitAudioContext)();
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();
              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);
              oscillator.frequency.value = 800;
              oscillator.type = 'sine';
              gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
              oscillator.start(audioContext.currentTime);
              oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
              // Ignorar erro de som
            }

            input.value = result.text;
            scanStatus.textContent = "‚úì C√≥digo detectado!";

            setTimeout(() => {
              fecharCamera();
              buscar();
            }, 500);
          }
        });

      } catch (err) {
        console.error('Erro ao acessar c√¢mera:', err);

        let mensagem = 'N√£o foi poss√≠vel acessar a c√¢mera.';
        if (err.name === 'NotAllowedError') {
          mensagem = 'Permiss√£o de c√¢mera negada. Por favor, permita o acesso nas configura√ß√µes do navegador.';
        } else if (err.name === 'NotFoundError') {
          mensagem = 'Nenhuma c√¢mera encontrada no dispositivo.';
        }

        alert(mensagem);
        fecharCamera();
      }
    };

    document.getElementById("close-camera").onclick = fecharCamera;

    // Fechar c√¢mera ao pressionar ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && videoContainer.classList.contains('active')) {
        fecharCamera();
      }
    });

    function fecharCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      if (codeReader) {
        codeReader.reset();
        codeReader = null;
      }
      video.srcObject = null;
      videoContainer.classList.remove('active');
      scanStatus.textContent = "Posicione o c√≥digo de barras no centro";
    }

    // ========================================
    // TOGGLE PESAGEM E BLUETOOTH
    // ========================================
    const togglePesagem = document.getElementById('toggle-pesagem');
    const pesoContainer = document.getElementById('peso-container');
    const pesoInput = document.getElementById('peso');
    const conectarBalancaBtn = document.getElementById('conectar-balanca');
    const bluetoothStatus = document.getElementById('bluetooth-status');
    const quantidadeInput = document.getElementById('quantidade');
    const salvarInventarioBtn = document.getElementById('salvar-inventario');

    let bluetoothDevice = null;
    let bluetoothCharacteristic = null;
    let produtoAtual = null;

    // Toggle mostrar/esconder campo de peso
    togglePesagem.addEventListener('change', () => {
      if (togglePesagem.checked) {
        pesoContainer.classList.add('visible');
      } else {
        pesoContainer.classList.remove('visible');
        // Desconectar balan√ßa se estiver conectada
        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
          bluetoothDevice.gatt.disconnect();
        }
        pesoInput.value = '';
      }
    });

    // Conectar Balan√ßa Bluetooth (Electrolux Kitchen Scale GKS.1136 BT)
    conectarBalancaBtn.addEventListener('click', async () => {
      try {
        bluetoothStatus.textContent = 'Procurando balan√ßa...';
        bluetoothStatus.style.color = '#666';

        // Procurar dispositivo Bluetooth
        // A balan√ßa Electrolux GKS.1136 BT geralmente usa o servi√ßo de peso padr√£o
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          filters: [
            { namePrefix: 'Electrolux' },
            { namePrefix: 'GKS' },
            { namePrefix: 'Kitchen' },
            { namePrefix: 'Scale' },
            { namePrefix: 'BT Scale' }
          ],
          optionalServices: [
            '0000181d-0000-1000-8000-00805f9b34fb', // Weight Scale Service
            '0000181b-0000-1000-8000-00805f9b34fb', // Body Composition Service
            '0000fff0-0000-1000-8000-00805f9b34fb', // Generic Custom Service
            '00001800-0000-1000-8000-00805f9b34fb', // Generic Access
            '00001801-0000-1000-8000-00805f9b34fb'  // Generic Attribute
          ],
          acceptAllDevices: false
        });

        bluetoothStatus.textContent = 'Conectando...';

        // Conectar ao GATT Server
        const server = await bluetoothDevice.gatt.connect();

        // Tentar encontrar o servi√ßo de peso
        let service;
        try {
          service = await server.getPrimaryService('0000181d-0000-1000-8000-00805f9b34fb');
        } catch (e) {
          // Tentar servi√ßo alternativo
          try {
            service = await server.getPrimaryService('0000fff0-0000-1000-8000-00805f9b34fb');
          } catch (e2) {
            // Listar todos os servi√ßos dispon√≠veis
            const services = await server.getPrimaryServices();
            if (services.length > 0) {
              service = services[0];
            } else {
              throw new Error('Nenhum servi√ßo encontrado');
            }
          }
        }

        // Encontrar a caracter√≠stica de peso
        const characteristics = await service.getCharacteristics();

        for (const char of characteristics) {
          if (char.properties.notify || char.properties.indicate) {
            bluetoothCharacteristic = char;
            break;
          }
        }

        if (!bluetoothCharacteristic) {
          bluetoothCharacteristic = characteristics[0];
        }

        // Iniciar notifica√ß√µes
        if (bluetoothCharacteristic.properties.notify) {
          await bluetoothCharacteristic.startNotifications();
          bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleWeightData);
        }

        // Atualizar UI
        conectarBalancaBtn.classList.add('connected');
        bluetoothStatus.textContent = 'Balan√ßa conectada! Aguardando peso...';
        bluetoothStatus.style.color = '#4CAF50';

        // Monitorar desconex√£o
        bluetoothDevice.addEventListener('gattserverdisconnected', () => {
          conectarBalancaBtn.classList.remove('connected');
          bluetoothStatus.textContent = 'Balan√ßa desconectada. Clique para reconectar.';
          bluetoothStatus.style.color = '#f44336';
          pesoInput.value = '';
        });

      } catch (error) {
        console.error('Erro Bluetooth:', error);

        let mensagem = 'Erro ao conectar √† balan√ßa.';
        if (error.name === 'NotFoundError') {
          mensagem = 'Nenhuma balan√ßa encontrada. Certifique-se que est√° ligada.';
        } else if (error.name === 'SecurityError') {
          mensagem = 'Permiss√£o Bluetooth negada.';
        } else if (error.message) {
          mensagem = error.message;
        }

        bluetoothStatus.textContent = mensagem;
        bluetoothStatus.style.color = '#f44336';
      }
    });

    // Processar dados de peso da balan√ßa
    function handleWeightData(event) {
      const value = event.target.value;
      const data = new Uint8Array(value.buffer);

      // Interpretar dados - formato pode variar por balan√ßa
      // Formato comum: peso em gramas ou kg como inteiro/float
      let peso = 0;

      if (data.length >= 2) {
        // Tentar interpretar como peso em gramas (little-endian)
        peso = (data[1] << 8) | data[0];
        peso = peso / 1000; // Converter para kg
      } else if (data.length === 1) {
        peso = data[0] / 10;
      }

      // Validar peso
      if (peso > 0 && peso < 50) {
        pesoInput.value = peso.toFixed(3);
        atualizarBotaoSalvar();
      }
    }

    // ========================================
    // SALVAR NO INVENT√ÅRIO
    // ========================================

    // Atualizar estado do bot√£o salvar
    function atualizarBotaoSalvar() {
      const codigo = input.value.replace(/\D/g, "");
      const quantidade = parseInt(quantidadeInput.value) || 0;

      if (codigo && quantidade > 0) {
        salvarInventarioBtn.disabled = false;
      } else {
        salvarInventarioBtn.disabled = true;
      }
    }

    // Monitorar mudan√ßas
    input.addEventListener('input', atualizarBotaoSalvar);
    quantidadeInput.addEventListener('input', atualizarBotaoSalvar);

    // Sobrescrever fun√ß√£o mostrarProduto para guardar produto atual
    const originalMostrarProduto = mostrarProduto;
    mostrarProduto = function(produto, origem) {
      produtoAtual = produto;
      originalMostrarProduto(produto, origem);
      atualizarBotaoSalvar();
    };

    // Salvar no invent√°rio
    salvarInventarioBtn.addEventListener('click', async () => {
      const codigo = input.value.replace(/\D/g, "");
      const quantidade = parseInt(quantidadeInput.value) || 1;
      const peso = pesoInput.value || '';

      if (!codigo) {
        alert('Digite ou escaneie um c√≥digo de barras.');
        return;
      }

      const dadosInventario = {
        codigo: codigo,
        produto: produtoAtual?.produto || produtoAtual?.nome || '',
        quantidade: quantidade,
        peso: peso,
        dataHora: new Date().toISOString()
      };

      try {
        salvarInventarioBtn.disabled = true;
        salvarInventarioBtn.innerHTML = `
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          Salvando...
        `;

        const resp = await fetch('/api/inventario', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dadosInventario)
        });

        const result = await resp.json();

        if (result.ok) {
          salvarInventarioBtn.innerHTML = `
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
            Salvo com sucesso!
          `;
          salvarInventarioBtn.style.background = '#4CAF50';

          // Resetar ap√≥s 2 segundos
          setTimeout(() => {
            salvarInventarioBtn.innerHTML = `
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                <polyline points="17,21 17,13 7,13 7,21"/>
                <polyline points="7,3 7,8 15,8"/>
              </svg>
              Salvar no Invent√°rio
            `;
            salvarInventarioBtn.style.background = '#000000';
            salvarInventarioBtn.disabled = false;

            // Limpar campos para pr√≥ximo produto
            quantidadeInput.value = '1';
          }, 2000);
        } else {
          throw new Error(result.error || 'Erro ao salvar');
        }
      } catch (error) {
        console.error('Erro ao salvar invent√°rio:', error);
        alert('Erro ao salvar no invent√°rio: ' + error.message);

        salvarInventarioBtn.innerHTML = `
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
            <polyline points="17,21 17,13 7,13 7,21"/>
            <polyline points="7,3 7,8 15,8"/>
          </svg>
          Salvar no Invent√°rio
        `;
        salvarInventarioBtn.disabled = false;
      }
    });


  </script>
</body>
</html>