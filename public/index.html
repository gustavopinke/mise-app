<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>MISE - Scanner</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #66F7CC;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 8px 15px 30px 15px;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: transparent;
      border-radius: 20px;
      padding: 0;
      text-align: center;
      overflow: hidden;
    }

    .form-content {
      padding: 15px 20px;
    }

    h2 {
      margin-top: 5px;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 16px;
      color: #333;
      line-height: 1.2;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      margin-top: 10px;
    }

    input {
      width: 100%;
      padding: 12px 45px 12px 12px;
      border: 2px solid #000;
      border-radius: 10px;
      font-size: 18px;
      text-align: center;
      box-sizing: border-box;
      -moz-appearance: textfield;
      background: transparent;
    }

    input::placeholder {
      color: #333;
    }

    /* Toggle Switch */
    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 15px;
      padding: 12px 15px;
      border: 2px solid #000;
      border-radius: 10px;
      background: transparent;
    }

    .toggle-label {
      font-size: 14px;
      font-weight: 600;
      color: #222;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: #6a5acd;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Campos de Peso e Quantidade */
    .peso-container {
      display: none;
      margin-top: 10px;
    }

    .peso-container.visible {
      display: block;
    }

    .peso-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .peso-input {
      flex: 1;
    }

    .bluetooth-btn {
      width: 50px;
      height: 50px;
      min-width: 50px;
      padding: 0;
      margin: 0;
      border-radius: 10px;
      background: #6a5acd;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .bluetooth-btn:hover {
      background: #5a4abd;
    }

    .bluetooth-btn.connected {
      background: #4CAF50;
    }

    .bluetooth-btn svg {
      width: 24px;
      height: 24px;
    }

    .quantidade-container {
      margin-top: 10px;
    }

    /* Label para campos */
    .field-label {
      display: block;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      margin-left: 5px;
    }

    /* Botao Salvar Inventario */
    #salvar-inventario {
      background: #000000;
      color: white;
      margin-top: 10px;
    }

    #salvar-inventario:disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
    }

    #salvar-inventario:not(:disabled):hover {
      background: #333;
    }

    /* Header com Logo */
    .header-logo {
      text-align: center;
      margin-bottom: 10px;
      margin-top: -15px;
    }

    .header-logo img {
      max-width: 130px;
      height: auto;
      margin-bottom: 2px;
    }

    .header-slogan {
      font-size: 22px;
      color: #222;
      font-weight: 500;
      margin-top: -5px;
      margin-bottom: 0;
      letter-spacing: 0.5px;
      line-height: 1.3;
    }

    .scanner-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin: 0 0 12px 0;
      text-align: center;
    }

    .clear-button {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      color: #999;
      border: none;
      width: 20px;
      height: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      line-height: 20px;
      padding: 0;
      margin: 0;
      transition: all 0.2s;
      font-family: Arial, sans-serif;
      font-weight: bold;
      text-align: center;
      vertical-align: middle;
    }

    .clear-button:hover {
      color: #666;
      transform: translateY(-50%) scale(1.1);
    }

    .clear-button.visible {
      display: flex;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      margin-top: 10px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
    }

    #buscar {
      background: #66F7CC;
      color: #222;
    }

    #scanner {
      background: #6a5acd;
      color: white;
    }

    button svg {
      width: 20px;
      height: 20px;
    }

    .produto-card {
      background: #f2f2f2;
      margin-top: 20px;
      padding: 18px;
      border-radius: 12px;
      text-align: left;
    }

    .produto-card h3 {
      margin: 0;
      font-size: 20px;
    }

    .produto-info {
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.8;
    }

    .produto-info p {
      margin: 8px 0;
    }

    /* Badge de fonte */
    .fonte-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 10px;
      text-transform: uppercase;
    }

    .fonte-badge.local {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .fonte-badge.online {
      background: #e3f2fd;
      color: #1565c0;
    }

    .fonte-badge.cache {
      background: #fff3e0;
      color: #ef6c00;
    }

    /* ========================================
       SCANNER PROFISSIONAL
       ======================================== */
    #scanner-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 1000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #scanner-container.active {
      display: flex;
    }

    #scanner-video-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #scanner-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* Garantir que o video nao vire/rotacione */
      transform: none !important;
      -webkit-transform: none !important;
    }

    /* Forcar orientacao natural em todos os casos */
    @media screen and (orientation: portrait) {
      #scanner-container.active {
        transform: none !important;
      }
      #scanner-video {
        transform: none !important;
      }
    }

    @media screen and (orientation: landscape) {
      #scanner-container.active {
        transform: none !important;
      }
      #scanner-video {
        transform: none !important;
      }
    }

    /* Overlay com marcas de scanner */
    #scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Area de leitura retangular com cantos verdes */
    #scan-area {
      position: relative;
      width: 80%;
      max-width: 400px;
      height: 120px;
      border: 2px solid rgba(102, 247, 204, 0.5);
      border-radius: 8px;
      background: transparent;
    }

    /* Cantos verdes do scanner */
    .scan-corner {
      position: absolute;
      width: 30px;
      height: 30px;
      border-color: #66F7CC;
      border-style: solid;
      border-width: 0;
    }

    .scan-corner.top-left {
      top: -2px;
      left: -2px;
      border-top-width: 4px;
      border-left-width: 4px;
      border-top-left-radius: 8px;
    }

    .scan-corner.top-right {
      top: -2px;
      right: -2px;
      border-top-width: 4px;
      border-right-width: 4px;
      border-top-right-radius: 8px;
    }

    .scan-corner.bottom-left {
      bottom: -2px;
      left: -2px;
      border-bottom-width: 4px;
      border-left-width: 4px;
      border-bottom-left-radius: 8px;
    }

    .scan-corner.bottom-right {
      bottom: -2px;
      right: -2px;
      border-bottom-width: 4px;
      border-right-width: 4px;
      border-bottom-right-radius: 8px;
    }

    /* Linha de scan animada */
    #scan-line {
      position: absolute;
      top: 50%;
      left: 5%;
      width: 90%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #66F7CC, transparent);
      animation: scan-pulse 1.5s ease-in-out infinite;
      box-shadow: 0 0 10px #66F7CC, 0 0 20px #66F7CC;
    }

    @keyframes scan-pulse {
      0%, 100% { opacity: 0.4; transform: scaleX(0.8); }
      50% { opacity: 1; transform: scaleX(1); }
    }

    /* Texto de instrucao */
    #scan-instruction {
      position: absolute;
      bottom: 20%;
      left: 0;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 14px;
      font-weight: 500;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      padding: 10px;
    }

    /* Status do scanner */
    #scan-status-bar {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #66F7CC;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10;
    }

    #scan-status-bar.success {
      background: rgba(76, 175, 80, 0.9);
      color: white;
    }

    #scan-status-bar.reading {
      background: rgba(255, 152, 0, 0.9);
      color: white;
    }

    /* Botao fechar */
    #close-scanner-btn {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(244, 67, 54, 0.9);
      color: white;
      border: none;
      padding: 12px 40px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      width: auto;
      margin: 0;
    }

    #close-scanner-btn:hover {
      background: rgba(211, 47, 47, 1);
      transform: translateX(-50%) scale(1.05);
    }

    /* Ultimo codigo lido */
    #last-scan-result {
      position: absolute;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #66F7CC;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 18px;
      font-weight: 700;
      font-family: monospace;
      letter-spacing: 2px;
      display: none;
      z-index: 10;
    }

    #last-scan-result.visible {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* Contador de leituras */
    #scan-counter {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      z-index: 10;
    }

    .produto-imagem {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 12px;
      margin: 15px auto;
      display: block;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .produto-imagem:hover {
      transform: scale(1.02);
    }

    #image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      gap: 20px;
    }

    #image-modal.active {
      display: flex;
    }

    #modal-image {
      max-width: 90%;
      max-height: 80%;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(102, 247, 204, 0.5);
    }

    #close-modal {
      background: #66F7CC;
      color: #000;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }

    /* Autocomplete de busca por nome */
    .busca-nome-container {
      position: relative;
      margin-top: 15px;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #000;
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .autocomplete-dropdown.visible {
      display: block;
    }

    .autocomplete-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover {
      background: #f0f0f0;
    }

    .autocomplete-item-nome {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .autocomplete-item-codigo {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    /* Modo continuo toggle */
    .scanner-mode-toggle {
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 10;
    }

    .scanner-mode-toggle label {
      color: white;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .scanner-mode-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div class="container">

    <div class="form-content">
      <!-- Logo e Slogan -->
      <div class="header-logo">
        <img src="/logo-mise.png" alt="MISE" onerror="this.style.display='none'">
        <p class="header-slogan">Prepare-se para o sucesso</p>
      </div>

      <p class="scanner-title">Scanner de Codigos de Barras</p>

      <!-- INPUT CODIGO DE BARRAS -->
      <div class="input-wrapper">
        <input
            id="codigo"
            type="text"
            placeholder="Digite ou escaneie o codigo"
            inputmode="numeric"
            pattern="[0-9]*"
        />
        <button class="clear-button" id="clear-button">X</button>
      </div>

      <!-- BUSCA POR NOME -->
      <div class="busca-nome-container">
        <label class="field-label">Buscar por nome do produto</label>
        <div class="input-wrapper">
          <input
              id="busca-nome"
              type="text"
              placeholder="Digite o nome do produto..."
          />
          <button class="clear-button" id="clear-busca-nome">X</button>
        </div>
        <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
      </div>

      <!-- TOGGLE PESAGEM -->
      <div class="toggle-container">
        <span class="toggle-label">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
          Pesar produto aberto
        </span>
        <label class="toggle-switch">
          <input type="checkbox" id="toggle-pesagem">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <!-- CAMPO DE PESO (visivel quando toggle ativo) -->
      <div class="peso-container" id="peso-container">
        <label class="field-label">Peso (kg)</label>
        <div class="peso-wrapper">
          <div class="input-wrapper peso-input">
            <input
                id="peso"
                type="text"
                placeholder="0.000"
                inputmode="decimal"
            />
          </div>
          <button class="bluetooth-btn" id="conectar-balanca" title="Conectar Balanca Bluetooth">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
            </svg>
          </button>
        </div>
        <p id="bluetooth-status" style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Digite o peso ou clique no icone para conectar a balanca</p>
      </div>

      <!-- CAMPO DE QUANTIDADE -->
      <div class="quantidade-container">
        <label class="field-label">Quantidade</label>
        <div class="input-wrapper">
          <input
              id="quantidade"
              type="number"
              placeholder="1"
              min="1"
              value="1"
          />
        </div>
      </div>

      <button id="buscar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        Buscar na base mise
      </button>

      <button id="scanner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        Scanner
      </button>

      <!-- BOTAO SALVAR INVENTARIO -->
      <button id="salvar-inventario" disabled>
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
          <polyline points="17,21 17,13 7,13 7,21"/>
          <polyline points="7,3 7,8 15,8"/>
        </svg>
        Salvar no Inventario
      </button>

      <div id="resultado"></div>
    </div>
  </div>

  <!-- CONTAINER DO SCANNER PROFISSIONAL -->
  <div id="scanner-container">
    <!-- Video da camera -->
    <div id="scanner-video-wrapper">
      <video id="scanner-video" autoplay playsinline></video>

      <!-- Overlay com marcas -->
      <div id="scanner-overlay">
        <div id="scan-area">
          <div class="scan-corner top-left"></div>
          <div class="scan-corner top-right"></div>
          <div class="scan-corner bottom-left"></div>
          <div class="scan-corner bottom-right"></div>
          <div id="scan-line"></div>
        </div>
      </div>

      <!-- Status -->
      <div id="scan-status-bar">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        <span id="scan-status-text">Aguardando camera...</span>
      </div>

      <!-- Contador -->
      <div id="scan-counter">Leituras: <span id="scan-count">0</span></div>

      <!-- Toggle modo continuo -->
      <div class="scanner-mode-toggle">
        <label>
          <input type="checkbox" id="modo-continuo" checked>
          Modo continuo (camera sempre aberta)
        </label>
      </div>

      <!-- Ultimo codigo lido -->
      <div id="last-scan-result"></div>

      <!-- Instrucao -->
      <div id="scan-instruction">Posicione o codigo de barras dentro da area verde</div>

      <!-- Botao fechar -->
      <button id="close-scanner-btn">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        Fechar Camera
      </button>
    </div>
  </div>

  <!-- MODAL PARA FOTO EM TAMANHO GRANDE -->
  <div id="image-modal">
    <img id="modal-image" src="" alt="Produto">
    <button id="close-modal">X Fechar</button>
  </div>

  <!-- Polyfill para BarcodeDetector - versao mais confiavel -->
  <script src="https://fastly.jsdelivr.net/npm/barcode-detector@2/dist/es2018.min.js"></script>
  <script>
    // Inicializar detector antecipadamente
    (async function() {
      try {
        // Aguardar polyfill carregar
        await new Promise(r => setTimeout(r, 100));

        if (typeof BarcodeDetector !== 'undefined') {
          console.log('BarcodeDetector disponivel, preparando...');

          // Pre-criar detector para acelerar primeira leitura
          const formatos = ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'qr_code'];
          const detector = new BarcodeDetector({ formats: formatos });
          console.log('Detector pre-inicializado com sucesso');
        } else {
          console.warn('BarcodeDetector nao disponivel apos polyfill');
        }
      } catch (e) {
        console.warn('Erro na pre-inicializacao:', e.message);
      }
    })();
  </script>
  <script>
    const input = document.getElementById("codigo");
    const resultado = document.getElementById("resultado");
    const scannerContainer = document.getElementById("scanner-container");
    const scannerVideo = document.getElementById("scanner-video");
    const imageModal = document.getElementById("image-modal");
    const modalImage = document.getElementById("modal-image");
    const scanStatusText = document.getElementById("scan-status-text");
    const scanStatusBar = document.getElementById("scan-status-bar");
    const lastScanResult = document.getElementById("last-scan-result");
    const scanCountSpan = document.getElementById("scan-count");
    const modoContinuoCheck = document.getElementById("modo-continuo");
    const clearButton = document.getElementById("clear-button");

    let mediaStream = null;
    let barcodeDetector = null;
    let scanInterval = null;
    let isScanning = false;
    let ultimaBusca = "";
    let buscaTimeout = null;
    let scanCount = 0;
    let lastScannedCode = "";
    let lastScanTime = 0;

    // Inicializar BarcodeDetector com todos os formatos possiveis
    async function initBarcodeDetector() {
      try {
        // Verificar se polyfill carregou
        if (typeof BarcodeDetector === 'undefined') {
          console.error('BarcodeDetector nao disponivel!');
          return false;
        }

        // Formatos mais comuns de codigo de barras
        const formatosDesejados = [
          'ean_13', 'ean_8', 'upc_a', 'upc_e',
          'code_128', 'code_39', 'code_93',
          'codabar', 'itf', 'qr_code', 'data_matrix'
        ];

        let formatosSuportados = formatosDesejados;

        // Verificar formatos suportados
        if (BarcodeDetector.getSupportedFormats) {
          try {
            const todosFormatos = await BarcodeDetector.getSupportedFormats();
            console.log('Formatos suportados pelo dispositivo:', todosFormatos);
            formatosSuportados = formatosDesejados.filter(f => todosFormatos.includes(f));
          } catch (e) {
            console.warn('Nao foi possivel verificar formatos:', e.message);
          }
        }

        // Usar pelo menos os formatos basicos
        if (formatosSuportados.length === 0) {
          formatosSuportados = ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'qr_code'];
        }

        console.log('Usando formatos:', formatosSuportados);

        barcodeDetector = new BarcodeDetector({
          formats: formatosSuportados
        });

        console.log('BarcodeDetector inicializado com sucesso!');
        return true;
      } catch (e) {
        console.error('Erro ao inicializar BarcodeDetector:', e);
        return false;
      }
    }

    // LIMPAR INPUT AO CLICAR NELE
    input.addEventListener('click', () => {
      input.value = '';
      clearButton.classList.remove('visible');
      resultado.innerHTML = '';
      ultimaBusca = '';
    });

    // MOSTRAR/ESCONDER BOTAO X
    input.addEventListener('input', () => {
      if (input.value.length > 0) {
        clearButton.classList.add('visible');
      } else {
        clearButton.classList.remove('visible');
      }
    });

    // LIMPAR INPUT AO CLICAR NO X
    clearButton.addEventListener('click', (e) => {
      e.preventDefault();
      input.value = '';
      clearButton.classList.remove('visible');
      resultado.innerHTML = '';
      ultimaBusca = '';
      input.focus();
    });

    // MODAL DE IMAGEM
    function abrirImagemModal(src) {
      modalImage.src = src;
      imageModal.classList.add('active');
    }

    function fecharImagemModal() {
      imageModal.classList.remove('active');
      modalImage.src = '';
    }

    document.getElementById("close-modal").onclick = fecharImagemModal;
    imageModal.onclick = (e) => {
      if (e.target === imageModal) {
        fecharImagemModal();
      }
    };

    // ENTER dispara busca
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        buscar();
      }
    });

    // Auto-busca quando digitar codigo completo (debounce)
    input.addEventListener("input", (e) => {
      const codigo = e.target.value.replace(/\D/g, "");

      if (buscaTimeout) clearTimeout(buscaTimeout);

      if (codigo.length >= 8 && codigo.length <= 14) {
        buscaTimeout = setTimeout(() => {
          if (codigo !== ultimaBusca) {
            buscar();
          }
        }, 500);
      }
    });

    document.getElementById("buscar").onclick = buscar;

    function mostrarProduto(produto, origem, fonte) {
      let infoHTML = '';
      const codigo = produto['cod de barra'] || produto['cod. de barra'] || produto.codigo || input.value.replace(/\D/g, "");

      // Mostrar todas as informacoes do produto
      for (const [key, value] of Object.entries(produto)) {
        if (value && key !== 'cod de barra' && key !== 'cod. de barra' && key !== 'codigo' && key !== 'produto' && key !== 'nome' && key !== 'foto' && key !== 'fonte') {
          const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
          infoHTML += `<p><b>${label}:</b> ${value}</p>`;
        }
      }

      // Badge de fonte
      let fonteBadgeClass = 'local';
      if (origem === 'online') fonteBadgeClass = 'online';
      else if (origem === 'cache') fonteBadgeClass = 'cache';

      let fonteBadge = `<span class="fonte-badge ${fonteBadgeClass}">${fonte || origem}</span>`;

      // Adicionar imagem se existir
      let imagemHTML = '';
      if (produto.foto) {
        let fotoUrl = '';
        if (typeof produto.foto === 'object' && produto.foto.url) {
          fotoUrl = produto.foto.url;
        } else if (typeof produto.foto === 'string') {
          fotoUrl = `/fotos/${produto.foto}`;
        }

        if (fotoUrl) {
          const altText = (produto.produto || produto.nome || 'Produto').replace(/"/g, '&quot;');
          const fotoUrlEscaped = fotoUrl.replace(/'/g, "\\'");
          imagemHTML = `<img src="${fotoUrl}" class="produto-imagem" alt="${altText}" onclick="abrirImagemModal('${fotoUrlEscaped}')" onerror="this.style.display='none';">`;
        }
      }

      resultado.innerHTML = `
        <div class="produto-card">
          ${imagemHTML}
          <h3>${produto.produto || produto.nome || 'Produto Encontrado'}</h3>
          ${fonteBadge}
          <div class="produto-info">
            <p><b>Codigo de Barras:</b> ${codigo}</p>
            ${infoHTML}
          </div>
        </div>
      `;
    }

    async function buscar() {
      const codigo = input.value.replace(/\D/g, "");

      if (!codigo) {
        resultado.innerHTML = "<p style='color: #999; margin-top: 20px;'>Digite um codigo valido.</p>";
        ultimaBusca = "";
        return;
      }

      if (codigo === ultimaBusca) {
        console.log("Codigo ja buscado, ignorando busca duplicada");
        return;
      }

      ultimaBusca = codigo;
      resultado.innerHTML = `<p style='margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;'>
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="animation: pulse 1s ease-in-out infinite;">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        Buscando...
      </p>
      <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
      </style>`;

      try {
        const resp = await fetch(`/consulta/${codigo}`);
        const data = await resp.json();

        if (!data.ok) {
          resultado.innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-radius: 10px; color: #c62828;">
              <strong>Produto nao encontrado</strong>
              <p style="margin: 5px 0 0 0; font-size: 14px;">Codigo: ${codigo}</p>
            </div>
          `;
          return;
        }

        mostrarProduto(data.produto, data.origem, data.fonte);
      } catch (error) {
        console.error("Erro na busca:", error);
        resultado.innerHTML = `
          <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 10px; color: #e65100;">
            <strong>Erro de conexao</strong>
            <p style="margin: 5px 0 0 0; font-size: 14px;">Verifique sua internet e tente novamente.</p>
          </div>
        `;
        ultimaBusca = "";
      }
    }

    // ========================================
    // SCANNER PROFISSIONAL
    // ========================================
    document.getElementById("scanner").onclick = async () => {
      await abrirScanner();
    };

    async function abrirScanner() {
      scannerContainer.classList.add('active');
      scanStatusText.textContent = "Iniciando camera...";
      scanStatusBar.className = '';
      scanCount = 0;
      scanCountSpan.textContent = '0';
      lastScanResult.classList.remove('visible');

      // Inicializar detector de codigo de barras
      if (!barcodeDetector) {
        const sucesso = await initBarcodeDetector();
        if (!sucesso) {
          console.error('Falha ao inicializar detector de barcode');
          scanStatusText.textContent = "Erro: detector de barcode nao disponivel";
        }
      }

      // Tentar abrir camera com diferentes configuracoes
      // Prioridade: camera traseira, alta resolucao, foco continuo
      let cameraAberta = false;

      const tentativas = [
        // 1. Camera traseira com resolucao alta (ideal para leitura de barcode)
        {
          video: {
            facingMode: { exact: 'environment' },
            width: { ideal: 1920, min: 1280 },
            height: { ideal: 1080, min: 720 },
            aspectRatio: { ideal: 16/9 }
          }
        },
        // 2. Camera traseira com resolucao media
        {
          video: {
            facingMode: { exact: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        },
        // 3. Camera traseira simples
        {
          video: {
            facingMode: 'environment'
          }
        },
        // 4. Qualquer camera traseira (ideal, nao exato)
        {
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        },
        // 5. Qualquer camera disponivel
        {
          video: true
        }
      ];

      for (const constraints of tentativas) {
        if (cameraAberta) break;
        try {
          console.log('Tentando constraints:', JSON.stringify(constraints));
          mediaStream = await navigator.mediaDevices.getUserMedia(constraints);

          // Verificar se realmente conseguiu abrir
          const tracks = mediaStream.getVideoTracks();
          if (tracks.length > 0) {
            const settings = tracks[0].getSettings();
            console.log('Camera aberta:', {
              width: settings.width,
              height: settings.height,
              facingMode: settings.facingMode,
              deviceId: settings.deviceId
            });
            cameraAberta = true;
          }
        } catch (e) {
          console.warn('Falha com constraints:', e.name, e.message);
        }
      }

      if (!cameraAberta || !mediaStream) {
        alert('Nao foi possivel acessar a camera. Verifique as permissoes do navegador.');
        fecharScanner();
        return;
      }

      try {
        scannerVideo.srcObject = mediaStream;

        // Tentar otimizar a camera para leitura de barcode
        try {
          const track = mediaStream.getVideoTracks()[0];
          if (track && track.getCapabilities) {
            const capabilities = track.getCapabilities();
            const constraintsAvancadas = [];

            // Foco continuo (melhor para scanner)
            if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
              constraintsAvancadas.push({ focusMode: 'continuous' });
              console.log('Foco continuo ativado');
            }

            // Exposicao automatica
            if (capabilities.exposureMode && capabilities.exposureMode.includes('continuous')) {
              constraintsAvancadas.push({ exposureMode: 'continuous' });
            }

            // Balanco de branco automatico
            if (capabilities.whiteBalanceMode && capabilities.whiteBalanceMode.includes('continuous')) {
              constraintsAvancadas.push({ whiteBalanceMode: 'continuous' });
            }

            // Torch/flash desligado (evitar reflexo)
            if (capabilities.torch) {
              constraintsAvancadas.push({ torch: false });
            }

            if (constraintsAvancadas.length > 0) {
              await track.applyConstraints({ advanced: constraintsAvancadas });
              console.log('Constraints avancadas aplicadas:', constraintsAvancadas);
            }
          }
        } catch (e) {
          console.warn('Nao foi possivel aplicar otimizacoes:', e.message);
        }

        // Esperar video estar pronto antes de iniciar deteccao
        scannerVideo.onloadedmetadata = async () => {
          try {
            await scannerVideo.play();
            isScanning = true;
            scanStatusText.textContent = "Camera pronta - aponte para o codigo";
            scanStatusBar.className = '';
            console.log('Video iniciado, resolucao:', scannerVideo.videoWidth, 'x', scannerVideo.videoHeight);

            // Iniciar deteccao continua
            startScanning();
          } catch (playErr) {
            console.error('Erro ao iniciar reproducao:', playErr);
            scanStatusText.textContent = "Erro ao iniciar video";
          }
        };

        // Fallback caso onloadedmetadata nao dispare
        setTimeout(async () => {
          if (!isScanning && scannerVideo.readyState >= 2) {
            try {
              await scannerVideo.play();
              isScanning = true;
              startScanning();
            } catch (e) {
              console.warn('Fallback play falhou:', e.message);
            }
          }
        }, 1000);

      } catch (err) {
        console.error('Erro ao iniciar video:', err);
        alert('Erro ao iniciar camera: ' + err.message);
        fecharScanner();
      }
    }

    // Canvas para processamento de imagem (melhora deteccao)
    let scanCanvas = null;
    let scanCtx = null;
    let falhasConsecutivas = 0;

    function startScanning() {
      if (scanInterval) clearInterval(scanInterval);

      // Criar canvas para melhor deteccao
      if (!scanCanvas) {
        scanCanvas = document.createElement('canvas');
        scanCtx = scanCanvas.getContext('2d', { willReadFrequently: true });
      }

      falhasConsecutivas = 0;

      // Intervalo mais rapido para melhor deteccao (15fps)
      scanInterval = setInterval(async () => {
        if (!isScanning || !barcodeDetector) return;

        // Verificar se video esta pronto
        if (scannerVideo.readyState < 2 || scannerVideo.videoWidth === 0) {
          return;
        }

        try {
          // Atualizar tamanho do canvas se necessario
          const vw = scannerVideo.videoWidth;
          const vh = scannerVideo.videoHeight;

          if (scanCanvas.width !== vw || scanCanvas.height !== vh) {
            scanCanvas.width = vw;
            scanCanvas.height = vh;
            console.log('Canvas redimensionado para:', vw, 'x', vh);
          }

          // Desenhar frame atual no canvas
          scanCtx.drawImage(scannerVideo, 0, 0, vw, vh);

          // Tentar detectar barcode diretamente do video primeiro
          let barcodes = [];
          try {
            barcodes = await barcodeDetector.detect(scannerVideo);
          } catch (e1) {
            // Se falhar com video, tentar com canvas
            try {
              barcodes = await barcodeDetector.detect(scanCanvas);
            } catch (e2) {
              // Tentar com ImageData (ultimo recurso)
              try {
                const imageData = scanCtx.getImageData(0, 0, vw, vh);
                barcodes = await barcodeDetector.detect(imageData);
              } catch (e3) {
                // Ignorar
              }
            }
          }

          if (barcodes.length > 0) {
            const code = barcodes[0].rawValue;
            const now = Date.now();

            // Validar codigo (deve ser numerico para EAN/UPC)
            const codigoLimpo = code.replace(/\D/g, '');
            if (codigoLimpo.length < 8 || codigoLimpo.length > 14) {
              console.log('Codigo invalido ignorado:', code);
              return;
            }

            // Evitar leituras duplicadas (800ms de debounce)
            if (code === lastScannedCode && (now - lastScanTime) < 800) {
              return;
            }

            console.log('Codigo detectado:', code, 'formato:', barcodes[0].format);

            lastScannedCode = code;
            lastScanTime = now;
            scanCount++;
            scanCountSpan.textContent = scanCount;
            falhasConsecutivas = 0;

            // Feedback visual
            scanStatusText.textContent = "Codigo detectado!";
            scanStatusBar.className = 'success';
            lastScanResult.textContent = codigoLimpo;
            lastScanResult.classList.add('visible');

            // Feedback sonoro
            playBeep();

            // Vibrar
            if (navigator.vibrate) {
              navigator.vibrate([100, 50, 100]);
            }

            // Atualizar input
            input.value = codigoLimpo;
            clearButton.classList.add('visible');

            // Se modo continuo, continuar escaneando
            // Se nao, fechar e buscar
            if (!modoContinuoCheck.checked) {
              setTimeout(() => {
                fecharScanner();
                buscar();
              }, 500);
            } else {
              // No modo continuo, fazer busca em background
              buscar();

              // Resetar status apos 2s
              setTimeout(() => {
                if (isScanning) {
                  scanStatusText.textContent = "Pronto para proxima leitura";
                  scanStatusBar.className = '';
                }
              }, 2000);
            }
          } else {
            falhasConsecutivas++;

            // Mostrar feedback se estiver demorando
            if (falhasConsecutivas > 50 && falhasConsecutivas % 30 === 0) {
              scanStatusText.textContent = "Aproxime o codigo de barras...";
              scanStatusBar.className = 'reading';
            }
          }
        } catch (e) {
          console.warn('Erro na deteccao:', e.message);
        }
      }, 66); // ~15fps para melhor deteccao
    }

    function playBeep() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 1200;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.15);
      } catch (e) {}
    }

    document.getElementById("close-scanner-btn").onclick = fecharScanner;

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && scannerContainer.classList.contains('active')) {
        fecharScanner();
      }
    });

    function fecharScanner() {
      console.log('Fechando scanner...');
      isScanning = false;

      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }

      if (mediaStream) {
        mediaStream.getTracks().forEach(track => {
          track.stop();
          console.log('Track parada:', track.kind);
        });
        mediaStream = null;
      }

      scannerVideo.srcObject = null;
      scannerVideo.onloadedmetadata = null;
      scannerContainer.classList.remove('active');
      lastScanResult.classList.remove('visible');
      scanStatusText.textContent = "Aguardando camera...";
      scanStatusBar.className = '';
      falhasConsecutivas = 0;

      console.log('Scanner fechado');
    }

    // ========================================
    // TOGGLE PESAGEM E BLUETOOTH
    // ========================================
    const togglePesagem = document.getElementById('toggle-pesagem');
    const pesoContainer = document.getElementById('peso-container');
    const pesoInput = document.getElementById('peso');
    const conectarBalancaBtn = document.getElementById('conectar-balanca');
    const bluetoothStatus = document.getElementById('bluetooth-status');
    const quantidadeInput = document.getElementById('quantidade');
    const salvarInventarioBtn = document.getElementById('salvar-inventario');

    let bluetoothDevice = null;
    let bluetoothCharacteristic = null;
    let produtoAtual = null;

    togglePesagem.addEventListener('change', () => {
      if (togglePesagem.checked) {
        pesoContainer.classList.add('visible');
      } else {
        pesoContainer.classList.remove('visible');
        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
          bluetoothDevice.gatt.disconnect();
        }
        pesoInput.value = '';
        ultimoPesoRecebido = 0;
      }
    });

    let pollingInterval = null;
    let allCharacteristics = [];
    let ultimoPesoRecebido = 0;
    let ultimaAtualizacaoStatus = 0;

    conectarBalancaBtn.addEventListener('click', async () => {
      try {
        if (typeof navigator === 'undefined' || !navigator.bluetooth || typeof navigator.bluetooth.requestDevice !== 'function') {
          bluetoothStatus.innerHTML = '<strong>Bluetooth nao suportado</strong><br><small>Web Bluetooth so funciona em Chrome no Android ou Chrome/Edge no computador.</small>';
          bluetoothStatus.style.color = '#f44336';
          return;
        }

        bluetoothStatus.textContent = 'Procurando balanca...';
        bluetoothStatus.style.color = '#666';

        const knownServices = [
          '0000181d-0000-1000-8000-00805f9b34fb',
          '0000181b-0000-1000-8000-00805f9b34fb',
          '0000fff0-0000-1000-8000-00805f9b34fb',
          '0000ffe0-0000-1000-8000-00805f9b34fb',
          '0000fee7-0000-1000-8000-00805f9b34fb',
          '00001800-0000-1000-8000-00805f9b34fb',
          '00001801-0000-1000-8000-00805f9b34fb',
          'battery_service'
        ];

        bluetoothDevice = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: knownServices
        });

        bluetoothStatus.textContent = 'Conectando...';
        const server = await bluetoothDevice.gatt.connect();

        const services = await server.getPrimaryServices();
        allCharacteristics = [];

        for (const service of services) {
          try {
            const chars = await service.getCharacteristics();
            for (const char of chars) {
              allCharacteristics.push(char);
              if (char.properties.notify || char.properties.indicate) {
                try {
                  if (char.properties.notify) {
                    await char.startNotifications();
                  }
                  char.addEventListener('characteristicvaluechanged', handleWeightData);
                } catch (e) {}
              }
            }
          } catch (e) {}
        }

        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(async () => {
          for (const char of allCharacteristics) {
            if (char.properties.read) {
              try {
                const value = await char.readValue();
                handleWeightData({ target: { value } });
              } catch (e) {}
            }
          }
        }, 500);

        conectarBalancaBtn.classList.add('connected');
        bluetoothStatus.textContent = 'Balanca conectada!';
        bluetoothStatus.style.color = '#4CAF50';

        bluetoothDevice.addEventListener('gattserverdisconnected', () => {
          conectarBalancaBtn.classList.remove('connected');
          bluetoothStatus.textContent = 'Balanca desconectada.';
          bluetoothStatus.style.color = '#f44336';
          pesoInput.value = '';
          ultimoPesoRecebido = 0;
          pesoEstavel = 0;
          pesoConfirmado = false;
          ultimoPesoConfirmado = 0;
          if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
          }
        });

      } catch (error) {
        console.error('Erro Bluetooth:', error);
        bluetoothStatus.textContent = 'Erro ao conectar.';
        bluetoothStatus.style.color = '#f44336';
      }
    });

    let pesoEstavel = 0;
    let tempoInicioEstabilizacao = 0;
    let pesoConfirmado = false;
    let ultimoPesoConfirmado = 0;
    const TEMPO_ESTABILIZACAO = 2000;
    const TOLERANCIA_PESO = 0.005;
    const TOLERANCIA_MUDANCA = 0.010;
    const PESO_MAXIMO = 10;

    function handleWeightData(event) {
      const value = event.target.value;
      const data = new Uint8Array(value.buffer);

      let peso = 0;
      let pesoEncontrado = false;

      if (data.length >= 2 && !pesoEncontrado) {
        const pesoGramas = (data[1] << 8) | data[0];
        if (pesoGramas > 0 && pesoGramas <= PESO_MAXIMO * 1000) {
          peso = pesoGramas / 1000;
          pesoEncontrado = true;
        }
      }

      if (data.length >= 3 && !pesoEncontrado) {
        const pesoGramas = (data[2] << 8) | data[1];
        if (pesoGramas > 0 && pesoGramas <= PESO_MAXIMO * 1000) {
          peso = pesoGramas / 1000;
          pesoEncontrado = true;
        }
      }

      if (data.length >= 2 && !pesoEncontrado) {
        const pesoGramas = (data[0] << 8) | data[1];
        if (pesoGramas > 0 && pesoGramas <= PESO_MAXIMO * 1000) {
          peso = pesoGramas / 1000;
          pesoEncontrado = true;
        }
      }

      if (!pesoEncontrado) {
        try {
          const texto = new TextDecoder().decode(data);
          const match = texto.match(/(\d+[.,]?\d*)/);
          if (match) {
            const pesoTexto = parseFloat(match[1].replace(',', '.'));
            if (pesoTexto > 0 && pesoTexto <= PESO_MAXIMO) {
              peso = pesoTexto;
              pesoEncontrado = true;
            }
          }
        } catch (e) {}
      }

      if (pesoEncontrado && peso > 0 && peso <= PESO_MAXIMO) {
        const agora = Date.now();

        if (pesoConfirmado) {
          if (Math.abs(peso - ultimoPesoConfirmado) > TOLERANCIA_MUDANCA) {
            pesoConfirmado = false;
            pesoEstavel = peso;
            tempoInicioEstabilizacao = agora;
            pesoInput.value = peso.toFixed(3);
            bluetoothStatus.textContent = `Peso: ${peso.toFixed(3)} kg (estabilizando...)`;
            bluetoothStatus.style.color = '#666';
          } else {
            pesoInput.value = peso.toFixed(3);
          }
        } else {
          if (Math.abs(peso - pesoEstavel) <= TOLERANCIA_PESO) {
            const tempoEstavel = agora - tempoInicioEstabilizacao;

            if (tempoEstavel >= TEMPO_ESTABILIZACAO) {
              pesoConfirmado = true;
              ultimoPesoConfirmado = peso;
              pesoInput.value = peso.toFixed(3);
              bluetoothStatus.innerHTML = `<strong>Peso confirmado: ${peso.toFixed(3)} kg</strong>`;
              bluetoothStatus.style.color = '#4CAF50';
              atualizarBotaoSalvar();

              playBeep();
              if (navigator.vibrate) navigator.vibrate(200);

            } else {
              const progresso = Math.min(100, (tempoEstavel / TEMPO_ESTABILIZACAO) * 100);
              pesoInput.value = peso.toFixed(3);
              bluetoothStatus.textContent = `Estabilizando... ${progresso.toFixed(0)}%`;
              bluetoothStatus.style.color = '#FF9800';
            }
          } else {
            pesoEstavel = peso;
            tempoInicioEstabilizacao = agora;
            pesoInput.value = peso.toFixed(3);
            bluetoothStatus.textContent = `Peso: ${peso.toFixed(3)} kg (estabilizando...)`;
            bluetoothStatus.style.color = '#666';
          }
        }

        ultimoPesoRecebido = peso;
      }
    }

    // ========================================
    // SALVAR NO INVENTARIO
    // ========================================

    function atualizarBotaoSalvar() {
      const codigo = input.value.replace(/\D/g, "");
      const quantidade = parseInt(quantidadeInput.value) || 0;

      if (codigo && quantidade > 0) {
        salvarInventarioBtn.disabled = false;
      } else {
        salvarInventarioBtn.disabled = true;
      }
    }

    input.addEventListener('input', atualizarBotaoSalvar);
    quantidadeInput.addEventListener('input', atualizarBotaoSalvar);

    const originalMostrarProduto = mostrarProduto;
    mostrarProduto = function(produto, origem, fonte) {
      produtoAtual = produto;
      originalMostrarProduto(produto, origem, fonte);
      atualizarBotaoSalvar();
    };

    // ========================================
    // BUSCA POR NOME COM AUTOCOMPLETE
    // ========================================
    const buscaNomeInput = document.getElementById('busca-nome');
    const clearBuscaNomeBtn = document.getElementById('clear-busca-nome');
    const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
    let buscaNomeTimeout = null;

    buscaNomeInput.addEventListener('input', () => {
      if (buscaNomeInput.value.length > 0) {
        clearBuscaNomeBtn.classList.add('visible');
      } else {
        clearBuscaNomeBtn.classList.remove('visible');
        autocompleteDropdown.classList.remove('visible');
      }

      if (buscaNomeTimeout) clearTimeout(buscaNomeTimeout);

      if (buscaNomeInput.value.length >= 2) {
        buscaNomeTimeout = setTimeout(() => {
          buscarPorNome(buscaNomeInput.value);
        }, 300);
      } else {
        autocompleteDropdown.classList.remove('visible');
      }
    });

    clearBuscaNomeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      buscaNomeInput.value = '';
      clearBuscaNomeBtn.classList.remove('visible');
      autocompleteDropdown.classList.remove('visible');
      buscaNomeInput.focus();
    });

    async function buscarPorNome(termo) {
      try {
        const resp = await fetch(`/api/buscar-por-nome/${encodeURIComponent(termo)}`);
        const data = await resp.json();

        if (data.ok && data.produtos.length > 0) {
          autocompleteDropdown.innerHTML = data.produtos.map(p => `
            <div class="autocomplete-item" data-codigo="${p.codigo}" data-nome="${p.nome}">
              <div class="autocomplete-item-nome">${p.nome}</div>
              <div class="autocomplete-item-codigo">Codigo: ${p.codigo}</div>
            </div>
          `).join('');
          autocompleteDropdown.classList.add('visible');

          autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', () => {
              const codigo = item.dataset.codigo;
              const nome = item.dataset.nome;

              input.value = codigo;
              clearButton.classList.add('visible');
              buscaNomeInput.value = nome;
              autocompleteDropdown.classList.remove('visible');

              buscar();
            });
          });
        } else {
          autocompleteDropdown.innerHTML = '<div class="autocomplete-item"><div class="autocomplete-item-nome" style="color: #999;">Nenhum produto encontrado</div></div>';
          autocompleteDropdown.classList.add('visible');
        }
      } catch (error) {
        console.error('Erro ao buscar por nome:', error);
        autocompleteDropdown.classList.remove('visible');
      }
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.busca-nome-container')) {
        autocompleteDropdown.classList.remove('visible');
      }
    });

    salvarInventarioBtn.addEventListener('click', async () => {
      const codigo = input.value.replace(/\D/g, "");
      const quantidade = parseInt(quantidadeInput.value) || 1;
      const peso = pesoInput.value || '';

      if (!codigo) {
        alert('Digite ou escaneie um codigo de barras.');
        return;
      }

      const dadosInventario = {
        codigo: codigo,
        produto: produtoAtual?.produto || produtoAtual?.nome || '',
        quantidade: quantidade,
        peso: peso,
        dataHora: new Date().toISOString()
      };

      try {
        salvarInventarioBtn.disabled = true;
        salvarInventarioBtn.innerHTML = `
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          Salvando...
        `;

        const resp = await fetch('/api/inventario', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dadosInventario)
        });

        const result = await resp.json();

        if (result.ok) {
          const textoSucesso = result.atualizado ? 'Quantidade atualizada!' : 'Salvo com sucesso!';
          salvarInventarioBtn.innerHTML = `
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
            ${textoSucesso}
          `;
          salvarInventarioBtn.style.background = result.atualizado ? '#2196F3' : '#4CAF50';

          setTimeout(() => {
            salvarInventarioBtn.innerHTML = `
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                <polyline points="17,21 17,13 7,13 7,21"/>
                <polyline points="7,3 7,8 15,8"/>
              </svg>
              Salvar no Inventario
            `;
            salvarInventarioBtn.style.background = '#000000';
            salvarInventarioBtn.disabled = false;

            quantidadeInput.value = '1';
          }, 2000);
        } else {
          throw new Error(result.error || 'Erro ao salvar');
        }
      } catch (error) {
        console.error('Erro ao salvar inventario:', error);
        alert('Erro ao salvar no inventario: ' + error.message);

        salvarInventarioBtn.innerHTML = `
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
            <polyline points="17,21 17,13 7,13 7,21"/>
            <polyline points="7,3 7,8 15,8"/>
          </svg>
          Salvar no Inventario
        `;
        salvarInventarioBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
